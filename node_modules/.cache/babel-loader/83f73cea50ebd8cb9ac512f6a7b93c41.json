{"ast":null,"code":"var _jsxFileName = \"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/src/layouts/ContentLayout.tsx\";\nimport React, { useState, useEffect } from 'react';\nimport styled from 'styled-components';\nimport { Input, message, Button, Dropdown, Menu, Modal, DatePicker } from 'antd';\nimport stores from '../stores';\nimport Format from '../utils/Format';\nimport { CurrentTaskKey } from '../stores/CurrentTaskStore';\nimport 'antd/dist/antd.css';\nimport { CurrentDoingTaskKey } from '../stores/CurrentDoingTaskStore';\n// import { DateType } from 'antd/lib/date-picker';\nimport { DownOutlined } from '@ant-design/icons';\nimport moment from 'moment';\nconst Container = styled.div`\n  background: #ffffff;\n  display: flex;\n  height: 100%;\n  flex-direction: column;\n`;\nconst Div = styled.div`\n`;\nconst Editor = styled(Input.TextArea)`\n  flex-grow: 1;\n`;\nconst ButtonGroup = styled(Button.Group)`\nmargin: 2px;\n`;\n\nconst ContentLayout = () => {\n  const {\n    storeModel\n  } = stores.useStore('mainmodel');\n  const {\n    currentTask\n  } = stores.useStore(CurrentTaskKey);\n  const {\n    save\n  } = stores.useStore('mainmodel');\n  const [content, setContent] = useState(\"\"); // toolsbar\n\n  const {\n    currentDoingTask,\n    setCurrentDoingTask\n  } = stores.useStore(CurrentDoingTaskKey);\n  /* ---------------------------初始化------------------------------- */\n  // 渲染当前note\n\n  const [lastTask, setLastTask] = useState(undefined);\n  useEffect(() => {\n    // console.log(`Current content:${content}`)\n    if (currentTask === undefined) return;\n\n    if (!currentTask.isSameTask(lastTask)) {\n      // todo 这里放同步应该不会有问题吧，最大的问题应该是前面切了note但没切content的时候进行保存...\n      setLastTask(currentTask);\n      setContent(currentTask.note.content);\n    }\n  });\n  /* ----------------------------保存Note文本------------------------------ */\n\n  function onBlur(event) {\n    event.preventDefault();\n    saveToLocal(event, false);\n  }\n\n  function saveToLocal(event, isManual) {\n    if (event) event.preventDefault();\n    if (currentTask === undefined) return;\n    currentTask.note.content = content;\n    save();\n    if (isManual) message.info(\"已保存\");\n  }\n  /* ------------------------------toolsbar---------------------------- */\n\n\n  function deleteTask(event) {\n    if (currentTask === undefined) return;\n    Modal.confirm({\n      title: '确定要删除吗？',\n      content: `是否删除任务：${currentTask.title}`,\n\n      onOk() {\n        if (storeModel.removeTask(currentTask)) {\n          message.success(\"删除任务成功\");\n          save();\n        } else {\n          message.error(\"删除任务失败\");\n        }\n      }\n\n    });\n  }\n\n  function doneTask(event) {\n    if (currentTask === undefined) return;\n    const task = currentTask;\n\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`);\n      return;\n    }\n\n    if (!task.isDoing()) {\n      Modal.confirm({\n        title: '当前任务不在进行中，确定要完成吗？',\n        content: `是否完成任务：${task.title}`,\n\n        onOk() {\n          _realDone(task);\n        }\n\n      });\n      return;\n    }\n\n    task.stop();\n    setCurrentDoingTask(undefined);\n\n    _realDone(task);\n  }\n\n  function _realDone(task) {\n    task.done();\n    storeModel.orderTasks();\n    message.success(\"任务已完成\");\n    save();\n  }\n\n  function startTask(event) {\n    if (currentTask === undefined) return;\n    const task = currentTask;\n\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`);\n      return;\n    }\n\n    if (currentDoingTask != undefined && currentDoingTask.id === task.id) {\n      message.error(`任务已经在进行中，上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`);\n      return;\n    }\n\n    if (task.isDoing()) {\n      // todo 自动恢复\n      message.error(`任务异常中断，重新开始。上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`);\n    }\n\n    if (currentDoingTask != undefined) {\n      currentDoingTask.stop();\n    }\n\n    task.start();\n    setCurrentDoingTask(task);\n    save();\n  }\n\n  function getMenu() {\n    if (currentTask === undefined) return /*#__PURE__*/React.createElement(Div, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 157,\n        columnNumber: 44\n      }\n    });\n    const task = currentTask;\n    return /*#__PURE__*/React.createElement(Menu, {\n      onClick: param => onClickMenu(param, task),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 161,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"1\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 162,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 1\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"2\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 163,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 2\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"3\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 164,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 3\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"4\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 165,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 4\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"5\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 166,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 5\"));\n  }\n\n  const onClickMenu = (param, task) => {\n    task.level = Number(param.key);\n    storeModel.orderTasks();\n    save();\n    param.domEvent.preventDefault(); // 怎么阻止对 parent 的点击事件\n    // param.domEvent.stopPropagation()\n  };\n\n  function formartLevel() {\n    if (currentTask === undefined) return \"\";\n    const task = currentTask;\n\n    switch (task.level) {\n      case 1:\n        return \"❗\";\n\n      case 2:\n        return \"🎏\";\n\n      case 3:\n        return \"3️⃣\";\n\n      case 4:\n        return \"4️\";\n\n      case 5:\n        return \"5️\";\n\n      default:\n        return \"\";\n    }\n  }\n\n  function onChooseDeadline(value) {\n    if (currentTask === undefined) return;\n    const task = currentTask; // 整了半天，原来直接 valueOf() 就行，百度了半天\n    // if(value instanceof Moment){\n    //   let moment:Moment = value\n    //   console.log('onOk: ', moment.);\n    // }\n    // console.log('onOk: ', value.valueOf());\n\n    task.deadlines.push(value.valueOf());\n  }\n\n  function getDeadlineTime() {\n    if (currentTask === undefined) return undefined;\n    const task = currentTask;\n    const deadline = task.getActualDeadline();\n\n    if (deadline > 0) {\n      return moment(deadline);\n    }\n\n    return undefined;\n  }\n  /* ---------------------------------------------------------- */\n\n\n  return /*#__PURE__*/React.createElement(Container, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 232,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(ButtonGroup, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 234,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    onClick: e => deleteTask(e),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 237,\n      columnNumber: 9\n    }\n  }, \"D\"), /*#__PURE__*/React.createElement(Button, {\n    onClick: e => doneTask(e),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 239,\n      columnNumber: 9\n    }\n  }, \"Done\"), /*#__PURE__*/React.createElement(Button, {\n    type: \"primary\",\n    onClick: e => startTask(e),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 240,\n      columnNumber: 9\n    }\n  }, \"Start\"), /*#__PURE__*/React.createElement(Dropdown, {\n    overlay: getMenu(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 242,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(\"a\", {\n    style: {\n      paddingLeft: 5\n    },\n    className: \"ant-dropdown-link\",\n    onClick: e => e.preventDefault(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 243,\n      columnNumber: 11\n    }\n  }, formartLevel(), \" \", /*#__PURE__*/React.createElement(DownOutlined, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 244,\n      columnNumber: 30\n    }\n  })))), /*#__PURE__*/React.createElement(DatePicker, {\n    showTime: true,\n    defaultValue: getDeadlineTime(task),\n    onOk: value => onChooseDeadline(value, task),\n    size: \"small\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 250,\n      columnNumber: 7\n    }\n  }), /*#__PURE__*/React.createElement(Editor, {\n    placeholder: \"\\u4EFB\\u52A1\\u65E5\\u5FD7\\uFF08\\u81EA\\u52A8\\u4FDD\\u5B58\\uFF09\",\n    value: content,\n    onChange: event => setContent(event.target.value),\n    onBlur: e => onBlur(e),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 252,\n      columnNumber: 7\n    }\n  }));\n};\n\nexport default ContentLayout;","map":{"version":3,"sources":["/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/src/layouts/ContentLayout.tsx"],"names":["React","useState","useEffect","styled","Input","message","Button","Dropdown","Menu","Modal","DatePicker","stores","Format","CurrentTaskKey","CurrentDoingTaskKey","DownOutlined","moment","Container","div","Div","Editor","TextArea","ButtonGroup","Group","ContentLayout","storeModel","useStore","currentTask","save","content","setContent","currentDoingTask","setCurrentDoingTask","lastTask","setLastTask","undefined","isSameTask","note","onBlur","event","preventDefault","saveToLocal","isManual","info","deleteTask","confirm","title","onOk","removeTask","success","error","doneTask","task","isDone","formatTimeInMs","doneTime","isDoing","_realDone","stop","done","orderTasks","startTask","id","lastStartTime","start","getMenu","param","onClickMenu","level","Number","key","domEvent","formartLevel","onChooseDeadline","value","deadlines","push","valueOf","getDeadlineTime","deadline","getActualDeadline","e","paddingLeft","target"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from 'react';\nimport styled from 'styled-components';\nimport { Input, message, Button, List, Dropdown, Menu, Modal, DatePicker } from 'antd';\nimport stores from '../stores';\nimport { Task } from '../model/model'\nimport { StoreModel, Duration } from '../model/model'\nimport Utils from '../utils/Utils'\nimport DateUtils from '../utils/DateUtils'\nimport Format from '../utils/Format'\nimport { CurrentTaskKey } from '../stores/CurrentTaskStore';\nimport 'antd/dist/antd.css';\nimport { CurrentDoingTaskKey } from '../stores/CurrentDoingTaskStore';\nimport { ClickParam } from 'antd/lib/menu';\n// import { DateType } from 'antd/lib/date-picker';\nimport { DownOutlined } from '@ant-design/icons';\nimport moment from 'moment'\n\nconst Container = styled.div`\n  background: #ffffff;\n  display: flex;\n  height: 100%;\n  flex-direction: column;\n`\n\nconst Div = styled.div`\n`\n\nconst Editor = styled(Input.TextArea)`\n  flex-grow: 1;\n`\n\nconst ButtonGroup = styled(Button.Group)`\nmargin: 2px;\n`\n\nconst ContentLayout: React.FC = () => {\n  const { storeModel } = stores.useStore('mainmodel') as { storeModel: StoreModel };\n  const { currentTask } = stores.useStore(CurrentTaskKey) as { currentTask: Task | undefined }\n  const { save } = stores.useStore('mainmodel') as { save: () => void };\n  const [content, setContent] = useState(\"\")\n\n  // toolsbar\n  const { currentDoingTask, setCurrentDoingTask } = stores.useStore(CurrentDoingTaskKey) as { currentDoingTask: Task | undefined, setCurrentDoingTask: (note: Task | undefined) => void }\n\n  /* ---------------------------初始化------------------------------- */\n\n  // 渲染当前note\n  const [lastTask, setLastTask] = useState<Task | undefined>(undefined)\n  useEffect(() => {\n    // console.log(`Current content:${content}`)\n    if (currentTask === undefined) return\n\n    if (!currentTask.isSameTask(lastTask)) {\n      // todo 这里放同步应该不会有问题吧，最大的问题应该是前面切了note但没切content的时候进行保存...\n      setLastTask(currentTask)\n      setContent(currentTask.note.content)\n    }\n  })\n\n  /* ----------------------------保存Note文本------------------------------ */\n\n  function onBlur(event: any) {\n    event.preventDefault();\n    saveToLocal(event, false)\n  }\n\n  function saveToLocal(event: any, isManual: boolean) {\n    if (event) event.preventDefault();\n    if (currentTask === undefined) return\n\n    currentTask.note.content = content\n    save()\n\n    if (isManual) message.info(\"已保存\")\n  }\n\n  /* ------------------------------toolsbar---------------------------- */\n\n  function deleteTask(event: any) {\n    if (currentTask === undefined) return\n\n    Modal.confirm({\n      title: '确定要删除吗？',\n      content: `是否删除任务：${currentTask.title}`,\n      onOk() {\n        if (storeModel.removeTask(currentTask)) {\n          message.success(\"删除任务成功\")\n          save()\n        } else {\n          message.error(\"删除任务失败\")\n        }\n      },\n    });\n  }\n\n  function doneTask(event: any) {\n    if (currentTask === undefined) return\n    const task = currentTask\n\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`)\n      return\n    }\n\n    if (!task.isDoing()) {\n      Modal.confirm({\n        title: '当前任务不在进行中，确定要完成吗？',\n        content: `是否完成任务：${task.title}`,\n        onOk() {\n          _realDone(task)\n        },\n      });\n      return\n    }\n\n    task.stop()\n    setCurrentDoingTask(undefined)\n    _realDone(task)\n  }\n\n  function _realDone(task: Task) {\n    task.done()\n    storeModel.orderTasks()\n    message.success(\"任务已完成\")\n    save()\n  }\n\n  function startTask(event: any) {\n    if (currentTask === undefined) return\n    const task = currentTask\n\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`)\n      return\n    }\n\n    if (currentDoingTask != undefined && currentDoingTask.id === task.id) {\n      message.error(`任务已经在进行中，上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`)\n      return\n    }\n\n    if (task.isDoing()) {\n      // todo 自动恢复\n      message.error(`任务异常中断，重新开始。上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`)\n    }\n\n    if (currentDoingTask != undefined) {\n      currentDoingTask.stop()\n    }\n\n    task.start()\n    setCurrentDoingTask(task)\n    save()\n  }\n\n  function getMenu(): React.ReactElement {\n    if (currentTask === undefined) return (<Div></Div>)\n    const task = currentTask\n\n    return (\n      <Menu onClick={(param) => onClickMenu(param, task)}>\n        <Menu.Item key=\"1\">优先级 1</Menu.Item>\n        <Menu.Item key=\"2\">优先级 2</Menu.Item>\n        <Menu.Item key=\"3\">优先级 3</Menu.Item>\n        <Menu.Item key=\"4\">优先级 4</Menu.Item>\n        <Menu.Item key=\"5\">优先级 5</Menu.Item>\n      </Menu>\n    )\n  }\n\n  const onClickMenu = (param: ClickParam, task: Task) => {\n    task.level = Number(param.key)\n\n    storeModel.orderTasks()\n    save()\n\n    param.domEvent.preventDefault()\n\n    // 怎么阻止对 parent 的点击事件\n    // param.domEvent.stopPropagation()\n  };\n\n  function formartLevel(): string {\n    if (currentTask === undefined) return \"\"\n    const task = currentTask\n\n    switch (task.level) {\n      case 1:\n        return \"❗\"\n      case 2:\n        return \"🎏\"\n      case 3:\n        return \"3️⃣\"\n      case 4:\n        return \"4️\"\n      case 5:\n        return \"5️\"\n      default:\n        return \"\"\n    }\n  }\n\n  function onChooseDeadline(value: any) {\n    if (currentTask === undefined) return\n    const task = currentTask\n\n    // 整了半天，原来直接 valueOf() 就行，百度了半天\n    // if(value instanceof Moment){\n    //   let moment:Moment = value\n    //   console.log('onOk: ', moment.);\n    // }\n    // console.log('onOk: ', value.valueOf());\n\n    task.deadlines.push(value.valueOf())\n  }\n\n  function getDeadlineTime(): any {\n    if (currentTask === undefined) return undefined\n    const task = currentTask\n\n    const deadline = task.getActualDeadline();\n    if (deadline > 0) {\n      return moment(deadline)\n    }\n\n    return undefined\n  }\n\n  /* ---------------------------------------------------------- */\n\n  return (\n    <Container>\n      {/* todo 没有 currentTask 就不展示 */}\n      <ButtonGroup>\n        {/* 点击整行就是查看且开始，view是只查看不开始。暂时用不着吧 */}\n        {/* <Button type=\"primary\" size=\"small\">view</Button> */}\n        <Button onClick={(e) => deleteTask(e)}>D</Button>\n        {/* <Button type=\"primary\" size=\"small\" onClick={(e) => startTask(e, task)}>Stop</Button> */}\n        <Button onClick={(e) => doneTask(e)}>Done</Button>\n        <Button type=\"primary\" onClick={(e) => startTask(e)}>Start</Button>\n\n        <Dropdown overlay={getMenu()}>\n          <a style={{ paddingLeft: 5 }} className=\"ant-dropdown-link\" onClick={e => e.preventDefault()}>\n            {formartLevel()} <DownOutlined />\n          </a>\n        </Dropdown>\n\n      </ButtonGroup>\n\n      <DatePicker showTime defaultValue={getDeadlineTime(task)} onOk={value => onChooseDeadline(value, task)} size=\"small\" />\n\n      <Editor\n        placeholder=\"任务日志（自动保存）\" value={content} onChange={(event) => setContent(event.target.value)} onBlur={(e) => onBlur(e)}\n      />\n    </Container>\n  );\n}\n\nexport default ContentLayout;"]},"metadata":{},"sourceType":"module"}