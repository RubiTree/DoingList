{"ast":null,"code":"import _initializerDefineProperty from\"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/initializerDefineProperty\";import _classCallCheck from\"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _applyDecoratedDescriptor from\"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/applyDecoratedDescriptor\";import _initializerWarningHelper from\"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/initializerWarningHelper\";var _dec,_dec2,_class,_descriptor,_descriptor2,_class2,_temp,_dec3,_class3,_descriptor3,_temp2,_dec4,_dec5,_class5,_descriptor4,_descriptor5,_temp3;import Utils from'../utils/Utils';import{Type}from\"class-transformer\";import DateUtils from'../utils/DateUtils';import Format from'../utils/Format';var Task=(_dec=Type(function(){return Note;}),_dec2=Type(function(){return Duration;}),(_class=(_temp=_class2=/*#__PURE__*/function(){function Task(){_classCallCheck(this,Task);this.id=-1;this.title=\"undefine\";_initializerDefineProperty(this,\"note\",_descriptor,this);this.level=3;this.createTime=-1;this.doneTime=-1;this.pendingDeadline=-1;this.pendingReason=\"\";this.deadlines=[];this.expectConsumes=[];this.expectStartTime=-1;_initializerDefineProperty(this,\"doingDurs\",_descriptor2,this);this.cycleId=-1;}_createClass(Task,[{key:\"init\",// 反序列化不能有带参数的构造器\n// public constructor(title: string) {\n//     this.title = title\n//     this.createTime = Utils.getTimestamp()\n//     this.id = Utils.generateId() + Task.idCounter\n//     Task.idCounter = Task.idCounter + 1000\n// }\nvalue:function init(title){this.title=title;this.createTime=Utils.getTimestamp();this.expectStartTime=this.createTime;this.id=Utils.generateId()+Task.idCounter;Task.idCounter=Task.idCounter+1000;}},{key:\"adaptData\",value:function adaptData(){if(this.expectStartTime===-1){this.expectStartTime=this.createTime;}}},{key:\"isSameTask\",value:function isSameTask(task){if(task===undefined){return false;}else{return this.id===task.id;}}},{key:\"isDoing\",value:function isDoing(){if(this.doingDurs.length===0){return false;}else{var lastTask=this.doingDurs[this.doingDurs.length-1];return lastTask.end===-1;}}},{key:\"isStarted\",value:function isStarted(){return this.doingDurs.length!==0;}},{key:\"lastStartTime\",value:function lastStartTime(){if(this.doingDurs.length===0){return-1;}else{var lastTask=this.doingDurs[this.doingDurs.length-1];return lastTask.start;}}},{key:\"start\",value:function start(){var duration=new Duration();var currentTime=Utils.getTimestamp();duration.init(currentTime);this.doingDurs.push(duration);if(currentTime<this.expectStartTime){this.expectStartTime=currentTime;}}},{key:\"stop\",value:function stop(){this.doingDurs[this.doingDurs.length-1].end=Utils.getTimestamp();}},{key:\"stopDelay\",value:function stopDelay(delay){this.doingDurs[this.doingDurs.length-1].end=Utils.getTimestamp()+delay;}},{key:\"isDone\",value:function isDone(){return this.doneTime!==-1;}},{key:\"isPending\",value:function isPending(){return this.pendingDeadline!==-1;}},{key:\"isDangerousPending\",value:function isDangerousPending(){return this.isTimeDangers(this.pendingDeadline);}},{key:\"isDangerousDeadline\",value:function isDangerousDeadline(){return this.isTimeDangers(this.getActualDeadline());}},{key:\"isDangerous\",value:function isDangerous(){return this.isDangerousPending()||this.isDangerousDeadline();}/**\n     * dealine 距离还有2个小时，或者已经过了\n     */},{key:\"isTimeDangers\",value:function isTimeDangers(deadline){if(deadline<=0){return false;}if(deadline-Utils.getTimestamp()<=2*60*60*1000){return true;}return false;}},{key:\"done\",value:function done(){this.doneTime=Utils.getTimestamp();}// 返回毫秒数\n// todo rename getAllDoingDuration\n},{key:\"getAllDuration\",value:function getAllDuration(){var _this=this;if(this.doingDurs.length===0){return 0;}return this.doingDurs.map(function(value,index){return value.getDur(index===_this.doingDurs.length-1);}).reduce(function(a,b){return a+b;});}},{key:\"getActualDeadline\",value:function getActualDeadline(){if(this.deadlines.length===0){return-1;}return this.deadlines[this.deadlines.length-1];}},{key:\"isHaveDeadline\",value:function isHaveDeadline(){return this.getActualDeadline()>0;}},{key:\"getActualExpectConsume\",value:function getActualExpectConsume(){if(this.expectConsumes.length===0){return-1;}return this.expectConsumes[this.expectConsumes.length-1];}},{key:\"isExpectConsume\",value:function isExpectConsume(){return this.getActualExpectConsume()>0;}// 超出预期时间返回多花的时间，负值\n// 用的时候有提前判断 getActualExpectConsume 是不是返回负值\n},{key:\"getLeftExpectConsumeTime\",value:function getLeftExpectConsumeTime(){var left=this.getActualExpectConsume()-this.getAllDuration();// 不用打印\n// if (left < 0) {\n//     console.error(\"超出预期时间\")\n// }\nreturn left;}}]);return Task;}(),_class2.idCounter=0,_temp),(_descriptor=_applyDecoratedDescriptor(_class.prototype,\"note\",[_dec],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return new Note();}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,\"doingDurs\",[_dec2],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return[];}})),_class));var Duration=/*#__PURE__*/function(){function Duration(){_classCallCheck(this,Duration);this.start=-1;this.end=-1;this.name=\"\";}_createClass(Duration,[{key:\"init\",// todo 没法重载\nvalue:function init(start){this.start=start;}},{key:\"init2\",value:function init2(start,end){this.start=start;if(end!=undefined){this.end=end;}}},{key:\"isIn\",value:function isIn(timeStamp){return timeStamp>=this.start&&timeStamp<=this.end;}},{key:\"getDur\",value:function getDur(isDoing){var end=this.end;if(end==-1&&isDoing){end=Utils.getTimestamp();}if(end==-1){console.error(\"这段时间未结束\");return 0;}return end-this.start;}},{key:\"isValid\",value:function isValid(isDoing){if(!isDoing&&this.end==-1)return false;return true;}}],[{key:\"create\",value:function create(start,end,name){var dur=new Duration();if(start!=undefined){dur.start=start;}if(end!=undefined){dur.end=end;}if(name!=undefined){dur.name=name;}return dur;}}]);return Duration;}();var CycleRecord=/*#__PURE__*/function(){function CycleRecord(){_classCallCheck(this,CycleRecord);this.id=-1;this._startTime=[];this._gap=[];this.title=\"undefine\";this.level=3;this.expectConsumes=-1;}_createClass(CycleRecord,[{key:\"init\",// ---- 模板\nvalue:function init(gap,title,level){this.id=Utils.generateId();this.title=title;this.level=level;this._gap.push(gap);this._startTime.push(Utils.getTimestamp());}},{key:\"getGap\",value:function getGap(){if(this._gap.length===0){return-1;}return this._gap[this._gap.length-1];}},{key:\"setGap\",value:function setGap(gap){this._gap.push(gap);}},{key:\"getStartTime\",value:function getStartTime(){if(this._startTime.length===0){return-1;}return this._startTime[this._startTime.length-1];}},{key:\"setStartTime\",value:function setStartTime(startTime){this._startTime.push(startTime);}/**\n     * 只要 currentTimeStamp 这天 0点-24点 在 starttime + n*gap 的这天 0点-24点，就创建任务\n     * 创建的方式是找最新创建的一个任务，然后拷贝它的属性（这个有点复杂，要考虑没有最新创建任务的情况，暂时不这么实现，而是使用模板吧）\n     */},{key:\"isTimeToCreateTask\",value:function isTimeToCreateTask(){var currentZero=DateUtils.getCurrentDayStamp(0);var startZero=DateUtils.getSomeDayStamp(this.getStartTime(),0);return(currentZero-startZero)%(this.getGap()*24*3600*1000)===0;}},{key:\"createTask\",value:function createTask(){var newTask=new Task();newTask.init(\"[\\u5468\\u671F|\".concat(Format.formatTimeInDay2(Utils.getTimestamp()),\"] \").concat(this.title));newTask.level=this.level;newTask.expectConsumes.push(this.expectConsumes);newTask.cycleId=this.id;return newTask;}}]);return CycleRecord;}();var Note=(_dec3=Type(function(){return TimeLine;}),(_class3=(_temp2=/*#__PURE__*/function(){function Note(){_classCallCheck(this,Note);this.content=\"\";_initializerDefineProperty(this,\"timeLines\",_descriptor3,this);}_createClass(Note,[{key:\"hasTimeLine\",value:function hasTimeLine(){return this.timeLines.length!==0;}},{key:\"endTimeLine\",value:function endTimeLine(){if(!this.hasTimeLine())return null;return this.timeLines[this.timeLines.length-1];}},{key:\"getFormartTimeLines\",value:function getFormartTimeLines(){return this.timeLines.slice().reverse().map(function(timeline){if(timeline.isDivder){return\"----- \".concat(Format.formatTimeInDay(timeline.timeStamp),\" -----\");}else{return\"\".concat(Format.formatTimeInSecond(timeline.timeStamp),\" \").concat(timeline.content);}}).join(\"\\n\");}}]);return Note;}(),_temp2),(_descriptor3=_applyDecoratedDescriptor(_class3.prototype,\"timeLines\",[_dec3],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return[];}})),_class3));var TimeLine=/*#__PURE__*/function(){function TimeLine(){_classCallCheck(this,TimeLine);this.timeStamp=-1;this.isDivder=false;this.content=\"\";}_createClass(TimeLine,null,[{key:\"createContentNode\",value:function createContentNode(content){var t=new TimeLine();t.timeStamp=Utils.getTimestamp();t.content=content;return t;}},{key:\"createDivNode\",value:function createDivNode(){var t=new TimeLine();t.timeStamp=Utils.getTimestamp();t.isDivder=true;return t;}}]);return TimeLine;}();var StoreModel=(_dec4=Type(function(){return Task;}),_dec5=Type(function(){return CycleRecord;}),(_class5=(_temp3=/*#__PURE__*/function(){function StoreModel(){_classCallCheck(this,StoreModel);_initializerDefineProperty(this,\"tasks\",_descriptor4,this);_initializerDefineProperty(this,\"cycleRecords\",_descriptor5,this);}_createClass(StoreModel,[{key:\"getTasks\",/**\n     * 筛选规则：\n     * 1. 所有 未完成 且 预期开始时间在今天endtime之前 的任务\n     * 2. 今天完成的任务\n     */value:function getTasks(dur){return this.tasks.filter(function(value){return!value.isDone()&&value.expectStartTime<=dur.end||dur.isIn(value.doneTime);});}},{key:\"addTask\",value:function addTask(task){if(this.containsProject(task.id))return;this.tasks.push(task);}},{key:\"addCycleRecord\",value:function addCycleRecord(cycleRecord){if(this.containsCycleRecord(cycleRecord.id))return;this.cycleRecords.push(cycleRecord);}},{key:\"invokeAddCycleTask\",value:function invokeAddCycleTask(){var _this2=this;this.cycleRecords.forEach(function(record){if(record.isTimeToCreateTask()){var isNotCreated=_this2.tasks.filter(function(task){var isSameId=task.cycleId===record.id;var isTodayTask=DateUtils.getMyCurrentDayDur2(0).isIn(task.createTime);// console.log(`isNotCreated, isSameId:${isSameId} isTodayTask:${isTodayTask}`)\nreturn isSameId&&isTodayTask;}).length===0;if(isNotCreated){// console.log(`create cycle task, record:${record.title}`)\n_this2.addTask(record.createTask());}}});}},{key:\"removeTask\",value:function removeTask(task){if(!this.containsProject(task.id))return false;var length=this.tasks.length;for(var i=0;i<length;i++){if(this.tasks[i].id===task.id){if(i===0){this.tasks.shift();//删除并返回数组的第一个元素\n}else if(i===length-1){this.tasks.pop();//删除并返回数组的最后一个元素\n}else{this.tasks.splice(i,1);//删除下标为i的元素\n}return true;}}return false;}},{key:\"containsProject\",value:function containsProject(id){return this.tasks.find(function(item){return item.id===id;})!==undefined;}},{key:\"containsCycleRecord\",value:function containsCycleRecord(id){return this.cycleRecords.find(function(item){return item.id===id;})!==undefined;}},{key:\"normalUpdate\",value:function normalUpdate(){this.invokeAddCycleTask();this.orderTasks();}},{key:\"orderTasks\",value:function orderTasks(){this.tasks.sort(function(a,b){// 完成的放最后\nif(a.isDone()&&!b.isDone()){return 1;}else if(!a.isDone()&&b.isDone()){return-1;}else{// 正在做的放最前\nif(a.isDoing()){return-1;}else if(b.isDoing()){return 1;}else{// 到时间的放前面\nif(a.isDangerous()&&!b.isDangerous()){return-1;}else if(!a.isDangerous()&&b.isDangerous()){return 1;}else{// 然后比较level\nif(a.level>b.level){return 1;}else if(a.level<b.level){return-1;}else{// 同样 level 比较创建时间\nif(a.createTime>b.createTime){return-1;}else if(a.createTime<b.createTime){return 1;}else{return 0;}}}}}});}}]);return StoreModel;}(),_temp3),(_descriptor4=_applyDecoratedDescriptor(_class5.prototype,\"tasks\",[_dec4],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return[];}}),_descriptor5=_applyDecoratedDescriptor(_class5.prototype,\"cycleRecords\",[_dec5],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return[];}})),_class5));export{Task,Duration,StoreModel,Note,CycleRecord,TimeLine};","map":{"version":3,"sources":["/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/src/model/model.ts"],"names":["Utils","Type","DateUtils","Format","Task","Note","Duration","id","title","level","createTime","doneTime","pendingDeadline","pendingReason","deadlines","expectConsumes","expectStartTime","cycleId","getTimestamp","generateId","idCounter","task","undefined","doingDurs","length","lastTask","end","start","duration","currentTime","init","push","delay","isTimeDangers","getActualDeadline","isDangerousPending","isDangerousDeadline","deadline","map","value","index","getDur","reduce","a","b","getActualExpectConsume","left","getAllDuration","name","timeStamp","isDoing","console","error","dur","CycleRecord","_startTime","_gap","gap","startTime","currentZero","getCurrentDayStamp","startZero","getSomeDayStamp","getStartTime","getGap","newTask","formatTimeInDay2","TimeLine","content","timeLines","hasTimeLine","slice","reverse","timeline","isDivder","formatTimeInDay","formatTimeInSecond","join","t","StoreModel","tasks","filter","isDone","isIn","containsProject","cycleRecord","containsCycleRecord","cycleRecords","forEach","record","isTimeToCreateTask","isNotCreated","isSameId","isTodayTask","getMyCurrentDayDur2","addTask","createTask","i","shift","pop","splice","find","item","invokeAddCycleTask","orderTasks","sort","isDangerous"],"mappings":"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","sourcesContent":["import Utils from '../utils/Utils'\nimport { Type } from \"class-transformer\";\nimport DateUtils from '../utils/DateUtils'\nimport Format from '../utils/Format'\n\nclass Task {\n    // todo delete 内存id增加器（因为mock初始化太快了，都在一个毫秒内）\n    private static idCounter = 0\n\n    public id: number = -1\n\n    public title: string = \"undefine\"\n\n    @Type(() => Note)\n    public note: Note = new Note()\n\n    public level: number = 3\n\n    public createTime: number = -1\n    public doneTime: number = -1\n\n    public pendingDeadline: number = -1\n    public pendingReason: string = \"\"\n\n    // 可修改，最后一个有效\n    public deadlines: number[] = []\n    // 预计花费时间，单位毫秒，可修改，最后一个有效\n    public expectConsumes: number[] = []\n    // 预期开始时间，默认是createTime，可以设置成不同时间，如果在 expectStartTime 前开始任务，此时间会自动变成这个开始任务的时间（显示逻辑一致）\n    public expectStartTime: number = -1\n\n    @Type(() => Duration)\n    public doingDurs: Duration[] = []\n\n    public cycleId: number = -1\n\n    // 反序列化不能有带参数的构造器\n    // public constructor(title: string) {\n    //     this.title = title\n    //     this.createTime = Utils.getTimestamp()\n\n    //     this.id = Utils.generateId() + Task.idCounter\n    //     Task.idCounter = Task.idCounter + 1000\n    // }\n\n    public init(title: string) {\n        this.title = title\n        this.createTime = Utils.getTimestamp()\n        this.expectStartTime = this.createTime\n\n        this.id = Utils.generateId() + Task.idCounter\n        Task.idCounter = Task.idCounter + 1000\n    }\n\n    public adaptData() {\n        if (this.expectStartTime === -1) {\n            this.expectStartTime = this.createTime\n        }\n    }\n\n    public isSameTask(task: Task | undefined): boolean {\n        if (task === undefined) {\n            return false\n        } else {\n            return this.id === task.id\n        }\n    }\n\n    public isDoing(): boolean {\n        if (this.doingDurs.length === 0) {\n            return false\n        } else {\n            let lastTask = this.doingDurs[this.doingDurs.length - 1]\n            return lastTask.end === -1\n        }\n    }\n\n    public isStarted(): boolean {\n        return this.doingDurs.length !== 0\n    }\n\n    public lastStartTime(): number {\n        if (this.doingDurs.length === 0) {\n            return -1\n        } else {\n            let lastTask = this.doingDurs[this.doingDurs.length - 1]\n            return lastTask.start\n        }\n    }\n\n    public start() {\n        let duration = new Duration()\n        const currentTime = Utils.getTimestamp();\n        duration.init(currentTime)\n        this.doingDurs.push(duration)\n\n        if (currentTime < this.expectStartTime) {\n            this.expectStartTime = currentTime\n        }\n    }\n\n    public stop() {\n        this.doingDurs[this.doingDurs.length - 1].end = Utils.getTimestamp()\n    }\n\n    public stopDelay(delay: number) {\n        this.doingDurs[this.doingDurs.length - 1].end = Utils.getTimestamp() + delay\n    }\n\n    public isDone(): boolean {\n        return this.doneTime !== -1\n    }\n\n    public isPending(): boolean {\n        return this.pendingDeadline !== -1\n    }\n\n    public isDangerousPending(): boolean {\n        return this.isTimeDangers(this.pendingDeadline)\n    }\n\n    public isDangerousDeadline(): boolean {\n        return this.isTimeDangers(this.getActualDeadline())\n    }\n\n    public isDangerous(): boolean {\n        return this.isDangerousPending() || this.isDangerousDeadline()\n    }\n\n    /**\n     * dealine 距离还有2个小时，或者已经过了\n     */\n    private isTimeDangers(deadline: number): boolean {\n        if (deadline <= 0) {\n            return false\n        }\n\n        if (deadline - Utils.getTimestamp() <= 2 * 60 * 60 * 1000) {\n            return true\n        }\n\n        return false\n    }\n\n    public done() {\n        this.doneTime = Utils.getTimestamp()\n    }\n\n    // 返回毫秒数\n    // todo rename getAllDoingDuration\n    public getAllDuration(): number {\n        if (this.doingDurs.length === 0) {\n            return 0\n        }\n\n        return this.doingDurs.map((value, index) => value.getDur(index === this.doingDurs.length - 1)).reduce((a, b) => a + b)\n    }\n\n    public getActualDeadline(): number {\n        if (this.deadlines.length === 0) {\n            return -1\n        }\n\n        return this.deadlines[this.deadlines.length - 1]\n    }\n\n    public isHaveDeadline(): boolean {\n        return this.getActualDeadline() > 0\n    }\n\n    public getActualExpectConsume(): number {\n        if (this.expectConsumes.length === 0) {\n            return -1\n        }\n\n        return this.expectConsumes[this.expectConsumes.length - 1]\n    }\n\n    public isExpectConsume(): boolean {\n        return this.getActualExpectConsume() > 0\n    }\n\n    // 超出预期时间返回多花的时间，负值\n    // 用的时候有提前判断 getActualExpectConsume 是不是返回负值\n    public getLeftExpectConsumeTime(): number {\n        let left = this.getActualExpectConsume() - this.getAllDuration()\n\n        // 不用打印\n        // if (left < 0) {\n        //     console.error(\"超出预期时间\")\n        // }\n\n        return left\n    }\n}\n\nclass Duration {\n    public start: number = -1\n    public end: number = -1\n    public name: string = \"\"\n\n    // todo 没法重载\n    public init(start: number) {\n        this.start = start\n    }\n    public init2(start: number, end?: number) {\n        this.start = start\n        if (end != undefined) {\n            this.end = end\n        }\n    }\n\n    public isIn(timeStamp: number) {\n        return timeStamp >= this.start && timeStamp <= this.end\n    }\n\n    public getDur(isDoing: boolean): number {\n        let end = this.end\n        if (end == -1 && isDoing) {\n            end = Utils.getTimestamp()\n        }\n        if (end == -1) {\n            console.error(\"这段时间未结束\")\n            return 0\n        }\n        return end - this.start\n    }\n\n    public isValid(isDoing: boolean) {\n        if (!isDoing && this.end == -1) return false\n        return true\n    }\n\n    public static create(start?: number, end?: number, name?: string): Duration {\n        let dur = new Duration()\n        if (start != undefined) {\n            dur.start = start\n        }\n        if (end != undefined) {\n            dur.end = end\n        }\n        if (name != undefined) {\n            dur.name = name\n        }\n        return dur\n    }\n}\n\nclass CycleRecord {\n    public id: number = -1\n    // 可以不断更新\n    public _startTime: number[] = []\n    // 单位天，其实不是gap，是 gap-1\n    public _gap: number[] = []\n\n    // ---- 模板\n    public title: string = \"undefine\"\n    public level: number = 3\n    public expectConsumes: number = -1\n    // ---- 模板\n\n    public init(gap: number, title: string, level: number) {\n        this.id = Utils.generateId()\n        this.title = title\n        this.level = level\n        this._gap.push(gap)\n        this._startTime.push(Utils.getTimestamp())\n    }\n\n    public getGap(): number {\n        if (this._gap.length === 0) {\n            return -1\n        }\n        return this._gap[this._gap.length - 1]\n    }\n\n    public setGap(gap: number) {\n        this._gap.push(gap)\n    }\n\n    public getStartTime(): number {\n        if (this._startTime.length === 0) {\n            return -1\n        }\n        return this._startTime[this._startTime.length - 1]\n    }\n\n    public setStartTime(startTime: number) {\n        this._startTime.push(startTime)\n    }\n\n    /**\n     * 只要 currentTimeStamp 这天 0点-24点 在 starttime + n*gap 的这天 0点-24点，就创建任务\n     * 创建的方式是找最新创建的一个任务，然后拷贝它的属性（这个有点复杂，要考虑没有最新创建任务的情况，暂时不这么实现，而是使用模板吧）\n     */\n    public isTimeToCreateTask(): boolean {\n        let currentZero = DateUtils.getCurrentDayStamp(0)\n        let startZero = DateUtils.getSomeDayStamp(this.getStartTime(), 0)\n        return (currentZero - startZero) % (this.getGap() * 24 * 3600 * 1000) === 0\n    }\n\n    public createTask(): Task {\n        const newTask = new Task()\n        newTask.init(`[周期|${Format.formatTimeInDay2(Utils.getTimestamp())}] ${this.title}`)\n        newTask.level = this.level\n        newTask.expectConsumes.push(this.expectConsumes)\n        newTask.cycleId = this.id\n        return newTask\n    }\n}\n\nclass Note {\n    public content: string = \"\"\n\n    @Type(() => TimeLine)\n    public timeLines: TimeLine[] = []\n\n    public hasTimeLine(): boolean {\n        return this.timeLines.length !== 0\n    }\n\n    public endTimeLine(): TimeLine|null {\n        if(!this.hasTimeLine()) return null\n        return this.timeLines[this.timeLines.length - 1]\n    }\n\n    public getFormartTimeLines(): string {\n        return this.timeLines.slice().reverse().map((timeline) => {\n            if (timeline.isDivder) {\n                return `----- ${Format.formatTimeInDay(timeline.timeStamp)} -----`\n            } else {\n                return `${Format.formatTimeInSecond(timeline.timeStamp)} ${timeline.content}`\n            }\n        }).join(\"\\n\")\n    }\n}\n\nclass TimeLine {\n    public timeStamp: number = -1\n    public isDivder: boolean = false\n    public content: string = \"\"\n\n    public static createContentNode(content: string): TimeLine{\n        const t = new TimeLine()\n        t.timeStamp = Utils.getTimestamp()\n        t.content = content\n        return t\n    }\n\n    public static createDivNode(): TimeLine{\n        const t = new TimeLine()\n        t.timeStamp = Utils.getTimestamp()\n        t.isDivder = true\n        return t\n    }\n}\n\nclass StoreModel {\n    @Type(() => Task)\n    public tasks: Task[] = []\n\n    @Type(() => CycleRecord)\n    public cycleRecords: CycleRecord[] = []\n\n    /**\n     * 筛选规则：\n     * 1. 所有 未完成 且 预期开始时间在今天endtime之前 的任务\n     * 2. 今天完成的任务\n     */\n    public getTasks(dur: Duration): Task[] {\n        return this.tasks.filter((value) => {\n            return (!value.isDone() && value.expectStartTime <= dur.end) || dur.isIn(value.doneTime)\n        })\n    }\n\n    public addTask(task: Task) {\n        if (this.containsProject(task.id)) return\n        this.tasks.push(task)\n    }\n\n    public addCycleRecord(cycleRecord: CycleRecord) {\n        if (this.containsCycleRecord(cycleRecord.id)) return\n        this.cycleRecords.push(cycleRecord)\n    }\n\n    public invokeAddCycleTask() {\n        this.cycleRecords.forEach(record => {\n            if (record.isTimeToCreateTask()) {\n                const isNotCreated = this.tasks.filter((task) => {\n                    const isSameId = task.cycleId === record.id\n                    const isTodayTask = DateUtils.getMyCurrentDayDur2(0).isIn(task.createTime)\n                    // console.log(`isNotCreated, isSameId:${isSameId} isTodayTask:${isTodayTask}`)\n                    return isSameId && isTodayTask\n                }).length === 0\n                if (isNotCreated) {\n                    // console.log(`create cycle task, record:${record.title}`)\n                    this.addTask(record.createTask())\n                }\n            }\n        });\n    }\n\n    public removeTask(task: Task): boolean {\n        if (!this.containsProject(task.id)) return false\n\n        let length = this.tasks.length;\n        for (let i = 0; i < length; i++) {\n            if (this.tasks[i].id === task.id) {\n                if (i === 0) {\n                    this.tasks.shift(); //删除并返回数组的第一个元素\n                } else if (i === length - 1) {\n                    this.tasks.pop();  //删除并返回数组的最后一个元素\n                } else {\n                    this.tasks.splice(i, 1); //删除下标为i的元素\n                }\n                return true\n            }\n        }\n        return false\n    }\n\n    private containsProject(id: number): boolean {\n        return this.tasks.find(item => item.id === id) !== undefined\n    }\n\n    private containsCycleRecord(id: number): boolean {\n        return this.cycleRecords.find(item => item.id === id) !== undefined\n    }\n\n    public normalUpdate() {\n        this.invokeAddCycleTask()\n        this.orderTasks()\n    }\n\n    public orderTasks() {\n        this.tasks.sort((a, b) => {\n            // 完成的放最后\n            if (a.isDone() && !b.isDone()) {\n                return 1\n            } else if (!a.isDone() && b.isDone()) {\n                return -1\n            } else {\n                // 正在做的放最前\n                if (a.isDoing()) {\n                    return -1\n                } else if (b.isDoing()) {\n                    return 1\n                } else {\n                    // 到时间的放前面\n                    if (a.isDangerous() && !b.isDangerous()) {\n                        return -1\n                    } else if (!a.isDangerous() && b.isDangerous()) {\n                        return 1\n                    } else {\n                        // 然后比较level\n                        if (a.level > b.level) {\n                            return 1\n                        } else if (a.level < b.level) {\n                            return -1\n                        } else {\n                            // 同样 level 比较创建时间\n                            if (a.createTime > b.createTime) {\n                                return -1\n                            } else if (a.createTime < b.createTime) {\n                                return 1\n                            } else {\n                                return 0\n                            }\n                        }\n                    }\n                }\n            }\n        })\n    }\n}\n\n\nexport { Task, Duration, StoreModel, Note, CycleRecord, TimeLine }"]},"metadata":{},"sourceType":"module"}