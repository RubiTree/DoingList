{"ast":null,"code":"import _initializerDefineProperty from \"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/initializerDefineProperty\";\nimport _applyDecoratedDescriptor from \"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/applyDecoratedDescriptor\";\nimport _initializerWarningHelper from \"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/initializerWarningHelper\";\n\nvar _dec, _dec2, _class, _descriptor, _descriptor2, _class2, _temp, _dec3, _class3, _descriptor3, _temp2, _dec4, _dec5, _class5, _descriptor4, _descriptor5, _temp3;\n\nimport Utils from '../utils/Utils';\nimport { Type } from \"class-transformer\";\nimport DateUtils from '../utils/DateUtils';\nimport Format from '../utils/Format';\nlet Task = (_dec = Type(() => Note), _dec2 = Type(() => Duration), (_class = (_temp = _class2 = class Task {\n  constructor() {\n    this.id = -1;\n    this.title = \"undefine\";\n\n    _initializerDefineProperty(this, \"note\", _descriptor, this);\n\n    this.level = 3;\n    this.createTime = -1;\n    this.doneTime = -1;\n    this.pendingDeadline = -1;\n    this.pendingReason = \"\";\n    this.deadlines = [];\n    this.expectConsumes = [];\n    this.expectStartTime = -1;\n    this.adjustConsume = 0;\n\n    _initializerDefineProperty(this, \"doingDurs\", _descriptor2, this);\n\n    this.cycleId = -1;\n  }\n\n  // 反序列化不能有带参数的构造器\n  // public constructor(title: string) {\n  //     this.title = title\n  //     this.createTime = Utils.getTimestamp()\n  //     this.id = Utils.generateId() + Task.idCounter\n  //     Task.idCounter = Task.idCounter + 1000\n  // }\n  init(title) {\n    this.title = title;\n    this.createTime = Utils.getTimestamp();\n    this.expectStartTime = this.createTime;\n    this.id = Utils.generateId() + Task.idCounter;\n    Task.idCounter = Task.idCounter + 1000;\n  }\n\n  adaptData() {\n    if (this.expectStartTime === -1) {\n      this.expectStartTime = this.createTime;\n    }\n  }\n\n  isSameTask(task) {\n    if (task === undefined) {\n      return false;\n    } else {\n      return this.id === task.id;\n    }\n  }\n\n  isDoing() {\n    if (this.doingDurs.length === 0) {\n      return false;\n    } else {\n      let lastTask = this.doingDurs[this.doingDurs.length - 1];\n      return lastTask.end === -1;\n    }\n  }\n\n  isStarted() {\n    return this.doingDurs.length !== 0;\n  }\n\n  lastStartTime() {\n    if (this.doingDurs.length === 0) {\n      return -1;\n    } else {\n      let lastTask = this.doingDurs[this.doingDurs.length - 1];\n      return lastTask.start;\n    }\n  }\n\n  start() {\n    let duration = new Duration();\n    const currentTime = Utils.getTimestamp();\n    duration.init(currentTime);\n    this.doingDurs.push(duration);\n\n    if (currentTime < this.expectStartTime) {\n      this.expectStartTime = currentTime;\n    }\n  }\n\n  stop() {\n    this.doingDurs[this.doingDurs.length - 1].end = Utils.getTimestamp();\n  }\n\n  stopDelay(delay) {\n    this.doingDurs[this.doingDurs.length - 1].end = Utils.getTimestamp() + delay;\n  }\n\n  isDone() {\n    return this.doneTime !== -1;\n  }\n\n  isPending() {\n    return this.pendingDeadline !== -1;\n  }\n\n  isDangerousPending() {\n    return this.isTimeDangers(this.pendingDeadline);\n  }\n\n  isDangerousDeadline() {\n    return this.isTimeDangers(this.getActualDeadline());\n  }\n\n  isDangerous() {\n    return this.isDangerousPending() || this.isDangerousDeadline();\n  }\n  /**\n   * dealine 距离还有2个小时，或者已经过了\n   */\n\n\n  isTimeDangers(deadline) {\n    if (deadline <= 0) {\n      return false;\n    }\n\n    if (deadline - Utils.getTimestamp() <= 2 * 60 * 60 * 1000) {\n      return true;\n    }\n\n    return false;\n  }\n\n  done() {\n    this.doneTime = Utils.getTimestamp();\n  } // 返回毫秒数\n  // todo rename getAllDoingDuration\n\n\n  getAllDuration() {\n    if (this.doingDurs.length === 0) {\n      return 0;\n    }\n\n    return this.doingDurs.map((value, index) => value.getDur(index === this.doingDurs.length - 1)).reduce((a, b) => a + b) + this.adjustConsume;\n  }\n\n  getActualDeadline() {\n    if (this.deadlines.length === 0) {\n      return -1;\n    }\n\n    return this.deadlines[this.deadlines.length - 1];\n  }\n\n  isHaveDeadline() {\n    return this.getActualDeadline() > 0;\n  }\n\n  getActualExpectConsume() {\n    if (this.expectConsumes.length === 0) {\n      return -1;\n    }\n\n    return this.expectConsumes[this.expectConsumes.length - 1];\n  }\n\n  isExpectConsume() {\n    return this.getActualExpectConsume() > 0;\n  } // 超出预期时间返回多花的时间，负值\n  // 用的时候有提前判断 getActualExpectConsume 是不是返回负值\n\n\n  getLeftExpectConsumeTime() {\n    let left = this.getActualExpectConsume() - this.getAllDuration(); // 不用打印\n    // if (left < 0) {\n    //     console.error(\"超出预期时间\")\n    // }\n\n    return left;\n  }\n\n}, _class2.idCounter = 0, _temp), (_descriptor = _applyDecoratedDescriptor(_class.prototype, \"note\", [_dec], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: function () {\n    return new Note();\n  }\n}), _descriptor2 = _applyDecoratedDescriptor(_class.prototype, \"doingDurs\", [_dec2], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: function () {\n    return [];\n  }\n})), _class));\n\nclass Duration {\n  constructor() {\n    this.start = -1;\n    this.end = -1;\n    this.name = \"\";\n  }\n\n  // todo 没法重载\n  init(start) {\n    this.start = start;\n  }\n\n  init2(start, end) {\n    this.start = start;\n\n    if (end != undefined) {\n      this.end = end;\n    }\n  }\n\n  isIn(timeStamp) {\n    return timeStamp >= this.start && timeStamp <= this.end;\n  }\n\n  getDur(isDoing) {\n    let end = this.end;\n\n    if (end == -1 && isDoing) {\n      end = Utils.getTimestamp();\n    }\n\n    if (end == -1) {\n      console.error(\"这段时间未结束\");\n      return 0;\n    }\n\n    return end - this.start;\n  }\n\n  isValid(isDoing) {\n    if (!isDoing && this.end == -1) return false;\n    return true;\n  }\n\n  static create(start, end, name) {\n    let dur = new Duration();\n\n    if (start != undefined) {\n      dur.start = start;\n    }\n\n    if (end != undefined) {\n      dur.end = end;\n    }\n\n    if (name != undefined) {\n      dur.name = name;\n    }\n\n    return dur;\n  }\n\n}\n\nclass CycleRecord {\n  constructor() {\n    this.id = -1;\n    this._startTime = [];\n    this._gap = [];\n    this.title = \"undefine\";\n    this.level = 3;\n    this.expectConsumes = -1;\n  }\n\n  // ---- 模板\n  init(gap, title, level) {\n    this.id = Utils.generateId();\n    this.title = title;\n    this.level = level;\n\n    this._gap.push(gap);\n\n    this._startTime.push(Utils.getTimestamp());\n  }\n\n  getGap() {\n    if (this._gap.length === 0) {\n      return -1;\n    }\n\n    return this._gap[this._gap.length - 1];\n  }\n\n  setGap(gap) {\n    this._gap.push(gap);\n  }\n\n  getStartTime() {\n    if (this._startTime.length === 0) {\n      return -1;\n    }\n\n    return this._startTime[this._startTime.length - 1];\n  }\n\n  setStartTime(startTime) {\n    this._startTime.push(startTime);\n  }\n  /**\n   * 只要 currentTimeStamp 这天 0点-24点 在 starttime + n*gap 的这天 0点-24点，就创建任务\n   * 创建的方式是找最新创建的一个任务，然后拷贝它的属性（这个有点复杂，要考虑没有最新创建任务的情况，暂时不这么实现，而是使用模板吧）\n   */\n\n\n  isTimeToCreateTask() {\n    let currentZero = DateUtils.getCurrentDayStamp(0);\n    let startZero = DateUtils.getSomeDayStamp(this.getStartTime(), 0);\n    return (currentZero - startZero) % (this.getGap() * 24 * 3600 * 1000) === 0;\n  }\n\n  createTask() {\n    const newTask = new Task();\n    newTask.init(`[周期|${Format.formatTimeInDay2(Utils.getTimestamp())}] ${this.title}`);\n    newTask.level = this.level;\n    newTask.expectConsumes.push(this.expectConsumes);\n    newTask.cycleId = this.id;\n    return newTask;\n  }\n\n}\n\nlet Note = (_dec3 = Type(() => TimeLine), (_class3 = (_temp2 = class Note {\n  constructor() {\n    this.content = \"\";\n\n    _initializerDefineProperty(this, \"timeLines\", _descriptor3, this);\n  }\n\n  hasTimeLine() {\n    return this.timeLines.length !== 0;\n  }\n\n  endTimeLine() {\n    if (!this.hasTimeLine()) return null;\n    return this.timeLines[this.timeLines.length - 1];\n  }\n\n  getFormartTimeLines() {\n    return this.timeLines.slice().reverse().map(timeline => {\n      if (timeline.isDivder) {\n        return `----- ${Format.formatTimeInDay(timeline.timeStamp)} -----`;\n      } else {\n        return `${Format.formatTimeInSecond(timeline.timeStamp)} ${timeline.content}`;\n      }\n    }).join(\"\\n\");\n  }\n\n}, _temp2), (_descriptor3 = _applyDecoratedDescriptor(_class3.prototype, \"timeLines\", [_dec3], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: function () {\n    return [];\n  }\n})), _class3));\n\nclass TimeLine {\n  constructor() {\n    this.timeStamp = -1;\n    this.isDivder = false;\n    this.content = \"\";\n  }\n\n  static createContentNode(content) {\n    const t = new TimeLine();\n    t.timeStamp = Utils.getTimestamp();\n    t.content = content;\n    return t;\n  }\n\n  static createDivNode() {\n    const t = new TimeLine();\n    t.timeStamp = Utils.getTimestamp();\n    t.isDivder = true;\n    return t;\n  }\n\n  getTitled(title) {\n    const copy = Object.assign({}, this); // copy.content = `【${title}】${copy.content}`\n\n    copy.content = `(${title})${copy.content}`;\n    return copy;\n  }\n\n}\n\nlet StoreModel = (_dec4 = Type(() => Task), _dec5 = Type(() => CycleRecord), (_class5 = (_temp3 = class StoreModel {\n  constructor() {\n    _initializerDefineProperty(this, \"tasks\", _descriptor4, this);\n\n    _initializerDefineProperty(this, \"cycleRecords\", _descriptor5, this);\n\n    this.totalAdjustConsumeTime = 0;\n  }\n\n  /**\n   * 筛选规则：\n   * 1. 所有 未完成 且 预期开始时间在今天endtime之前 的任务\n   * 2. 今天完成的任务\n   */\n  getTasks(dur) {\n    return this.tasks.filter(value => {\n      return !value.isDone() && value.expectStartTime <= dur.end || dur.isIn(value.doneTime);\n    });\n  }\n\n  getCurrentDayDoingTasks(dur) {\n    return this.tasks.filter(task => {\n      task.doingDurs.find(dur => {\n        du;\n      });\n      return dur.isIn(task.doneTime);\n    });\n  }\n\n  addTask(task) {\n    if (this.containsProject(task.id)) return;\n    this.tasks.push(task);\n  }\n\n  addCycleRecord(cycleRecord) {\n    if (this.containsCycleRecord(cycleRecord.id)) return;\n    this.cycleRecords.push(cycleRecord);\n  }\n\n  invokeAddCycleTask() {\n    this.cycleRecords.forEach(record => {\n      if (record.isTimeToCreateTask()) {\n        const isNotCreated = this.tasks.filter(task => {\n          const isSameId = task.cycleId === record.id;\n          const isTodayTask = DateUtils.getMyCurrentDayDur2(0).isIn(task.createTime); // console.log(`isNotCreated, isSameId:${isSameId} isTodayTask:${isTodayTask}`)\n\n          return isSameId && isTodayTask;\n        }).length === 0;\n\n        if (isNotCreated) {\n          // console.log(`create cycle task, record:${record.title}`)\n          this.addTask(record.createTask());\n        }\n      }\n    });\n  }\n\n  removeTask(task) {\n    if (!this.containsProject(task.id)) return false;\n    let length = this.tasks.length;\n\n    for (let i = 0; i < length; i++) {\n      if (this.tasks[i].id === task.id) {\n        if (i === 0) {\n          this.tasks.shift(); //删除并返回数组的第一个元素\n        } else if (i === length - 1) {\n          this.tasks.pop(); //删除并返回数组的最后一个元素\n        } else {\n          this.tasks.splice(i, 1); //删除下标为i的元素\n        }\n\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  containsProject(id) {\n    return this.tasks.find(item => item.id === id) !== undefined;\n  }\n\n  containsCycleRecord(id) {\n    return this.cycleRecords.find(item => item.id === id) !== undefined;\n  }\n\n  normalUpdate() {\n    this.invokeAddCycleTask();\n    this.orderTasks();\n  }\n\n  orderTasks() {\n    this.tasks.sort((a, b) => {\n      // 完成的放最后\n      if (a.isDone() && !b.isDone()) {\n        return 1;\n      } else if (!a.isDone() && b.isDone()) {\n        return -1;\n      } else {\n        // 正在做的放最前\n        if (a.isDoing()) {\n          return -1;\n        } else if (b.isDoing()) {\n          return 1;\n        } else {\n          // 到时间的放前面\n          if (a.isDangerous() && !b.isDangerous()) {\n            return -1;\n          } else if (!a.isDangerous() && b.isDangerous()) {\n            return 1;\n          } else {\n            // 然后比较level\n            if (a.level > b.level) {\n              return 1;\n            } else if (a.level < b.level) {\n              return -1;\n            } else {\n              // 同样 level 比较创建时间\n              if (a.createTime > b.createTime) {\n                return -1;\n              } else if (a.createTime < b.createTime) {\n                return 1;\n              } else {\n                return 0;\n              }\n            }\n          }\n        }\n      }\n    });\n  }\n\n}, _temp3), (_descriptor4 = _applyDecoratedDescriptor(_class5.prototype, \"tasks\", [_dec4], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: function () {\n    return [];\n  }\n}), _descriptor5 = _applyDecoratedDescriptor(_class5.prototype, \"cycleRecords\", [_dec5], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: function () {\n    return [];\n  }\n})), _class5));\nexport { Task, Duration, StoreModel, Note, CycleRecord, TimeLine };","map":{"version":3,"sources":["/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/src/model/model.ts"],"names":["Utils","Type","DateUtils","Format","Task","Note","Duration","id","title","level","createTime","doneTime","pendingDeadline","pendingReason","deadlines","expectConsumes","expectStartTime","adjustConsume","cycleId","init","getTimestamp","generateId","idCounter","adaptData","isSameTask","task","undefined","isDoing","doingDurs","length","lastTask","end","isStarted","lastStartTime","start","duration","currentTime","push","stop","stopDelay","delay","isDone","isPending","isDangerousPending","isTimeDangers","isDangerousDeadline","getActualDeadline","isDangerous","deadline","done","getAllDuration","map","value","index","getDur","reduce","a","b","isHaveDeadline","getActualExpectConsume","isExpectConsume","getLeftExpectConsumeTime","left","name","init2","isIn","timeStamp","console","error","isValid","create","dur","CycleRecord","_startTime","_gap","gap","getGap","setGap","getStartTime","setStartTime","startTime","isTimeToCreateTask","currentZero","getCurrentDayStamp","startZero","getSomeDayStamp","createTask","newTask","formatTimeInDay2","TimeLine","content","hasTimeLine","timeLines","endTimeLine","getFormartTimeLines","slice","reverse","timeline","isDivder","formatTimeInDay","formatTimeInSecond","join","createContentNode","t","createDivNode","getTitled","copy","Object","assign","StoreModel","totalAdjustConsumeTime","getTasks","tasks","filter","getCurrentDayDoingTasks","find","du","addTask","containsProject","addCycleRecord","cycleRecord","containsCycleRecord","cycleRecords","invokeAddCycleTask","forEach","record","isNotCreated","isSameId","isTodayTask","getMyCurrentDayDur2","removeTask","i","shift","pop","splice","item","normalUpdate","orderTasks","sort"],"mappings":"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","sourcesContent":["import Utils from '../utils/Utils'\nimport { Type } from \"class-transformer\";\nimport DateUtils from '../utils/DateUtils'\nimport Format from '../utils/Format'\n\nclass Task {\n    // todo delete 内存id增加器（因为mock初始化太快了，都在一个毫秒内）\n    private static idCounter = 0\n\n    public id: number = -1\n\n    public title: string = \"undefine\"\n\n    @Type(() => Note)\n    public note: Note = new Note()\n\n    public level: number = 3\n\n    public createTime: number = -1\n    public doneTime: number = -1\n\n    public pendingDeadline: number = -1\n    public pendingReason: string = \"\"\n\n    // 可修改，最后一个有效\n    public deadlines: number[] = []\n    // 预计花费时间，单位毫秒，可修改，最后一个有效\n    public expectConsumes: number[] = []\n    // 预期开始时间，默认是createTime，可以设置成不同时间，如果在 expectStartTime 前开始任务，此时间会自动变成这个开始任务的时间（显示逻辑一致）\n    public expectStartTime: number = -1\n\n    // 调整耗时，单位毫秒\n    public adjustConsume: number = 0\n\n    @Type(() => Duration)\n    public doingDurs: Duration[] = []\n\n    public cycleId: number = -1\n\n    // 反序列化不能有带参数的构造器\n    // public constructor(title: string) {\n    //     this.title = title\n    //     this.createTime = Utils.getTimestamp()\n\n    //     this.id = Utils.generateId() + Task.idCounter\n    //     Task.idCounter = Task.idCounter + 1000\n    // }\n\n    public init(title: string) {\n        this.title = title\n        this.createTime = Utils.getTimestamp()\n        this.expectStartTime = this.createTime\n\n        this.id = Utils.generateId() + Task.idCounter\n        Task.idCounter = Task.idCounter + 1000\n    }\n\n    public adaptData() {\n        if (this.expectStartTime === -1) {\n            this.expectStartTime = this.createTime\n        }\n    }\n\n    public isSameTask(task: Task | undefined): boolean {\n        if (task === undefined) {\n            return false\n        } else {\n            return this.id === task.id\n        }\n    }\n\n    public isDoing(): boolean {\n        if (this.doingDurs.length === 0) {\n            return false\n        } else {\n            let lastTask = this.doingDurs[this.doingDurs.length - 1]\n            return lastTask.end === -1\n        }\n    }\n\n    public isStarted(): boolean {\n        return this.doingDurs.length !== 0\n    }\n\n    public lastStartTime(): number {\n        if (this.doingDurs.length === 0) {\n            return -1\n        } else {\n            let lastTask = this.doingDurs[this.doingDurs.length - 1]\n            return lastTask.start\n        }\n    }\n\n    public start() {\n        let duration = new Duration()\n        const currentTime = Utils.getTimestamp();\n        duration.init(currentTime)\n        this.doingDurs.push(duration)\n\n        if (currentTime < this.expectStartTime) {\n            this.expectStartTime = currentTime\n        }\n    }\n\n    public stop() {\n        this.doingDurs[this.doingDurs.length - 1].end = Utils.getTimestamp()\n    }\n\n    public stopDelay(delay: number) {\n        this.doingDurs[this.doingDurs.length - 1].end = Utils.getTimestamp() + delay\n    }\n\n    public isDone(): boolean {\n        return this.doneTime !== -1\n    }\n\n    public isPending(): boolean {\n        return this.pendingDeadline !== -1\n    }\n\n    public isDangerousPending(): boolean {\n        return this.isTimeDangers(this.pendingDeadline)\n    }\n\n    public isDangerousDeadline(): boolean {\n        return this.isTimeDangers(this.getActualDeadline())\n    }\n\n    public isDangerous(): boolean {\n        return this.isDangerousPending() || this.isDangerousDeadline()\n    }\n\n    /**\n     * dealine 距离还有2个小时，或者已经过了\n     */\n    private isTimeDangers(deadline: number): boolean {\n        if (deadline <= 0) {\n            return false\n        }\n\n        if (deadline - Utils.getTimestamp() <= 2 * 60 * 60 * 1000) {\n            return true\n        }\n\n        return false\n    }\n\n    public done() {\n        this.doneTime = Utils.getTimestamp()\n    }\n\n    // 返回毫秒数\n    // todo rename getAllDoingDuration\n    public getAllDuration(): number {\n        if (this.doingDurs.length === 0) {\n            return 0\n        }\n\n        return this.doingDurs.map((value, index) => value.getDur(index === this.doingDurs.length - 1)).reduce((a, b) => a + b) + this.adjustConsume\n    }\n\n    public getActualDeadline(): number {\n        if (this.deadlines.length === 0) {\n            return -1\n        }\n\n        return this.deadlines[this.deadlines.length - 1]\n    }\n\n    public isHaveDeadline(): boolean {\n        return this.getActualDeadline() > 0\n    }\n\n    public getActualExpectConsume(): number {\n        if (this.expectConsumes.length === 0) {\n            return -1\n        }\n\n        return this.expectConsumes[this.expectConsumes.length - 1]\n    }\n\n    public isExpectConsume(): boolean {\n        return this.getActualExpectConsume() > 0\n    }\n\n    // 超出预期时间返回多花的时间，负值\n    // 用的时候有提前判断 getActualExpectConsume 是不是返回负值\n    public getLeftExpectConsumeTime(): number {\n        let left = this.getActualExpectConsume() - this.getAllDuration()\n\n        // 不用打印\n        // if (left < 0) {\n        //     console.error(\"超出预期时间\")\n        // }\n\n        return left\n    }\n}\n\nclass Duration {\n    public start: number = -1\n    public end: number = -1\n    public name: string = \"\"\n\n    // todo 没法重载\n    public init(start: number) {\n        this.start = start\n    }\n    public init2(start: number, end?: number) {\n        this.start = start\n        if (end != undefined) {\n            this.end = end\n        }\n    }\n\n    public isIn(timeStamp: number) {\n        return timeStamp >= this.start && timeStamp <= this.end\n    }\n\n    public getDur(isDoing: boolean): number {\n        let end = this.end\n        if (end == -1 && isDoing) {\n            end = Utils.getTimestamp()\n        }\n        if (end == -1) {\n            console.error(\"这段时间未结束\")\n            return 0\n        }\n        return end - this.start\n    }\n\n    public isValid(isDoing: boolean) {\n        if (!isDoing && this.end == -1) return false\n        return true\n    }\n\n    public static create(start?: number, end?: number, name?: string): Duration {\n        let dur = new Duration()\n        if (start != undefined) {\n            dur.start = start\n        }\n        if (end != undefined) {\n            dur.end = end\n        }\n        if (name != undefined) {\n            dur.name = name\n        }\n        return dur\n    }\n}\n\nclass CycleRecord {\n    public id: number = -1\n    // 可以不断更新\n    public _startTime: number[] = []\n    // 单位天，其实不是gap，是 gap-1\n    public _gap: number[] = []\n\n    // ---- 模板\n    public title: string = \"undefine\"\n    public level: number = 3\n    public expectConsumes: number = -1\n    // ---- 模板\n\n    public init(gap: number, title: string, level: number) {\n        this.id = Utils.generateId()\n        this.title = title\n        this.level = level\n        this._gap.push(gap)\n        this._startTime.push(Utils.getTimestamp())\n    }\n\n    public getGap(): number {\n        if (this._gap.length === 0) {\n            return -1\n        }\n        return this._gap[this._gap.length - 1]\n    }\n\n    public setGap(gap: number) {\n        this._gap.push(gap)\n    }\n\n    public getStartTime(): number {\n        if (this._startTime.length === 0) {\n            return -1\n        }\n        return this._startTime[this._startTime.length - 1]\n    }\n\n    public setStartTime(startTime: number) {\n        this._startTime.push(startTime)\n    }\n\n    /**\n     * 只要 currentTimeStamp 这天 0点-24点 在 starttime + n*gap 的这天 0点-24点，就创建任务\n     * 创建的方式是找最新创建的一个任务，然后拷贝它的属性（这个有点复杂，要考虑没有最新创建任务的情况，暂时不这么实现，而是使用模板吧）\n     */\n    public isTimeToCreateTask(): boolean {\n        let currentZero = DateUtils.getCurrentDayStamp(0)\n        let startZero = DateUtils.getSomeDayStamp(this.getStartTime(), 0)\n        return (currentZero - startZero) % (this.getGap() * 24 * 3600 * 1000) === 0\n    }\n\n    public createTask(): Task {\n        const newTask = new Task()\n        newTask.init(`[周期|${Format.formatTimeInDay2(Utils.getTimestamp())}] ${this.title}`)\n        newTask.level = this.level\n        newTask.expectConsumes.push(this.expectConsumes)\n        newTask.cycleId = this.id\n        return newTask\n    }\n}\n\nclass Note {\n    public content: string = \"\"\n\n    @Type(() => TimeLine)\n    public timeLines: TimeLine[] = []\n\n    public hasTimeLine(): boolean {\n        return this.timeLines.length !== 0\n    }\n\n    public endTimeLine(): TimeLine|null {\n        if(!this.hasTimeLine()) return null\n        return this.timeLines[this.timeLines.length - 1]\n    }\n\n    public getFormartTimeLines(): string {\n        return this.timeLines.slice().reverse().map((timeline) => {\n            if (timeline.isDivder) {\n                return `----- ${Format.formatTimeInDay(timeline.timeStamp)} -----`\n            } else {\n                return `${Format.formatTimeInSecond(timeline.timeStamp)} ${timeline.content}`\n            }\n        }).join(\"\\n\")\n    }\n}\n\nclass TimeLine {\n    public timeStamp: number = -1\n    public isDivder: boolean = false\n    public content: string = \"\"\n\n    public static createContentNode(content: string): TimeLine{\n        const t = new TimeLine()\n        t.timeStamp = Utils.getTimestamp()\n        t.content = content\n        return t\n    }\n\n    public static createDivNode(): TimeLine{\n        const t = new TimeLine()\n        t.timeStamp = Utils.getTimestamp()\n        t.isDivder = true\n        return t\n    }\n\n    public getTitled(title: string): TimeLine{\n        const copy = Object.assign({}, this)\n        // copy.content = `【${title}】${copy.content}`\n        copy.content = `(${title})${copy.content}`\n        return copy\n    }\n}\n\nclass StoreModel {\n    @Type(() => Task)\n    public tasks: Task[] = []\n\n    @Type(() => CycleRecord)\n    public cycleRecords: CycleRecord[] = []\n\n    public totalAdjustConsumeTime: number = 0\n\n    /**\n     * 筛选规则：\n     * 1. 所有 未完成 且 预期开始时间在今天endtime之前 的任务\n     * 2. 今天完成的任务\n     */\n    public getTasks(dur: Duration): Task[] {\n        return this.tasks.filter((value) => {\n            return (!value.isDone() && value.expectStartTime <= dur.end) || dur.isIn(value.doneTime)\n        })\n    }\n\n    public getCurrentDayDoingTasks(dur: Duration): Task[] {\n        return this.tasks.filter((task) => {\n            task.doingDurs.find((dur) => {\n                du\n            })\n            return dur.isIn(task.doneTime)\n        })\n    }\n\n    public addTask(task: Task) {\n        if (this.containsProject(task.id)) return\n        this.tasks.push(task)\n    }\n\n    public addCycleRecord(cycleRecord: CycleRecord) {\n        if (this.containsCycleRecord(cycleRecord.id)) return\n        this.cycleRecords.push(cycleRecord)\n    }\n\n    public invokeAddCycleTask() {\n        this.cycleRecords.forEach(record => {\n            if (record.isTimeToCreateTask()) {\n                const isNotCreated = this.tasks.filter((task) => {\n                    const isSameId = task.cycleId === record.id\n                    const isTodayTask = DateUtils.getMyCurrentDayDur2(0).isIn(task.createTime)\n                    // console.log(`isNotCreated, isSameId:${isSameId} isTodayTask:${isTodayTask}`)\n                    return isSameId && isTodayTask\n                }).length === 0\n                if (isNotCreated) {\n                    // console.log(`create cycle task, record:${record.title}`)\n                    this.addTask(record.createTask())\n                }\n            }\n        });\n    }\n\n    public removeTask(task: Task): boolean {\n        if (!this.containsProject(task.id)) return false\n\n        let length = this.tasks.length;\n        for (let i = 0; i < length; i++) {\n            if (this.tasks[i].id === task.id) {\n                if (i === 0) {\n                    this.tasks.shift(); //删除并返回数组的第一个元素\n                } else if (i === length - 1) {\n                    this.tasks.pop();  //删除并返回数组的最后一个元素\n                } else {\n                    this.tasks.splice(i, 1); //删除下标为i的元素\n                }\n                return true\n            }\n        }\n        return false\n    }\n\n    private containsProject(id: number): boolean {\n        return this.tasks.find(item => item.id === id) !== undefined\n    }\n\n    private containsCycleRecord(id: number): boolean {\n        return this.cycleRecords.find(item => item.id === id) !== undefined\n    }\n\n    public normalUpdate() {\n        this.invokeAddCycleTask()\n        this.orderTasks()\n    }\n\n    public orderTasks() {\n        this.tasks.sort((a, b) => {\n            // 完成的放最后\n            if (a.isDone() && !b.isDone()) {\n                return 1\n            } else if (!a.isDone() && b.isDone()) {\n                return -1\n            } else {\n                // 正在做的放最前\n                if (a.isDoing()) {\n                    return -1\n                } else if (b.isDoing()) {\n                    return 1\n                } else {\n                    // 到时间的放前面\n                    if (a.isDangerous() && !b.isDangerous()) {\n                        return -1\n                    } else if (!a.isDangerous() && b.isDangerous()) {\n                        return 1\n                    } else {\n                        // 然后比较level\n                        if (a.level > b.level) {\n                            return 1\n                        } else if (a.level < b.level) {\n                            return -1\n                        } else {\n                            // 同样 level 比较创建时间\n                            if (a.createTime > b.createTime) {\n                                return -1\n                            } else if (a.createTime < b.createTime) {\n                                return 1\n                            } else {\n                                return 0\n                            }\n                        }\n                    }\n                }\n            }\n        })\n    }\n}\n\n\nexport { Task, Duration, StoreModel, Note, CycleRecord, TimeLine }"]},"metadata":{},"sourceType":"module"}