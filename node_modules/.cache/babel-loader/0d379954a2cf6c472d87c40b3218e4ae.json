{"ast":null,"code":"var _jsxFileName = \"/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/src/layouts/TaskListContainer.tsx\";\nimport React, { useState, useEffect } from 'react';\nimport styled from 'styled-components';\nimport { Input, message, Button, List, Dropdown, Menu, Modal, DatePicker } from 'antd'; // 这样居然真的行\n\n// import { DateType } from 'antd/lib/date-picker';\nimport { DownOutlined } from '@ant-design/icons';\nimport stores from '../stores';\nimport { StoreModel } from '../model/model';\nimport Utils from '../utils/Utils';\nimport DateUtils from '../utils/DateUtils';\nimport Format from '../utils/Format';\nimport { Task } from '../model/model';\nimport { CurrentTaskKey } from '../stores/CurrentTaskStore';\nimport { CurrentDoingTaskKey } from '../stores/CurrentDoingTaskStore';\nimport { CurrentDayOffsetKey } from '../stores/CurrentDayOffsetStore';\nimport 'antd/dist/antd.css';\nimport moment from 'moment';\nimport { plainToClass } from \"class-transformer\";\nconst Container = styled.div`\n  /* background: #d1d3a2; */\n  /* background: #d1dfff; */\n  background: #282c34;\n`;\nconst Container2 = styled.div`\n  /* background: #d1d3a2; */\n  /* background: #d1dfff; */\n  background: #282c34;\n  overflow:auto;\n  /* height: 800px; */\n  height: 85vh;\n  margin-top:10px;\n`;\nconst InputGroup = styled(Input.Group)`\nmargin: 1%;\n`;\nconst ButtonGroup = styled(Button.Group)`\nmargin: 1%;\n`;\n\nconst TaskListContainer = () => {\n  const {\n    storeModel,\n    save,\n    setModel\n  } = stores.useStore('mainmodel');\n  const {\n    currentDayOffset,\n    setCurrentDayOffset\n  } = stores.useStore(CurrentDayOffsetKey);\n  const [title, setTitle] = useState(\"\");\n  const [expectTime, setExpectTime] = useState(2); // React.useEffect(() => {\n  //   console.log(\"TaskListContainer useEffect\")\n  // },[])\n\n  function onAddNote(event) {\n    event.preventDefault();\n\n    if (Utils.isStringEmpty(title)) {\n      message.error(\"请输入内容\");\n      return;\n    }\n\n    const newTask = new Task();\n    newTask.init(title);\n    newTask.expectConsumes.push(expectTime * 3600 * 1000); // 单位小时，转换\n\n    storeModel.addTask(newTask);\n    save();\n    setTitle(\"\");\n  }\n\n  function changeOffsetDay(isAdd) {\n    if (isAdd) {\n      setCurrentDayOffset(currentDayOffset + 1);\n    } else {\n      setCurrentDayOffset(currentDayOffset - 1);\n    }\n  }\n\n  function download() {\n    Utils.downloadFile(`DoingList_${Format.formatTimeInMsToFileName(Utils.getTimestamp())}.dl`, JSON.stringify(storeModel));\n  }\n\n  function upload(e) {\n    let file = e.target.files[0];\n    console.log(file);\n    let reader = new FileReader();\n\n    reader.onload = function () {\n      let uploadContent = this.result;\n\n      if (typeof uploadContent === 'string') {\n        Modal.confirm({\n          title: '确定要导入嘛？',\n          content: `导入会覆盖当前所有任务`,\n\n          onOk() {\n            Modal.confirm({\n              title: '是否需要先下载当前任务？',\n              content: ``,\n\n              onOk() {\n                download();\n                setModel(plainToClass(StoreModel, JSON.parse(uploadContent)));\n              },\n\n              onCancel() {\n                setModel(plainToClass(StoreModel, JSON.parse(uploadContent)));\n              }\n\n            });\n          }\n\n        });\n      } else {\n        message.error(\"导入文件有问题，导入失败\");\n      }\n    }; //读取文件内容\n\n\n    reader.readAsText(file);\n  }\n\n  function getOffsetString() {\n    let base = \"\" + currentDayOffset;\n\n    if (currentDayOffset > 0) {\n      base = \"+\" + base;\n    }\n\n    return base;\n  }\n\n  function getAllTaskStatus() {\n    let notDoneTasks = storeModel.getTasks(DateUtils.getMyCurrentDayDur(currentDayOffset)).filter(task => {\n      return !task.isDone();\n    });\n\n    if (notDoneTasks.length === 0) {\n      return \"\";\n    }\n\n    let consumeFormat = \"\";\n    let consumes = notDoneTasks.map(task => {\n      let left = task.getLeftExpectConsumeTime();\n      if (left < 0) return 0;\n      return left;\n    }).reduce((a, b) => a + b); // console.log(\"getAllTaskStatus\" + consumes)\n\n    if (consumes > 0) {\n      consumeFormat = `，总剩余预估需要花费${Format.formatDuration(consumes)}`;\n    }\n\n    return `共${notDoneTasks.length}个任务未完成${consumeFormat}`;\n  }\n\n  return /*#__PURE__*/React.createElement(Container, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 147,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(ButtonGroup, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 150,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    type: \"primary\",\n    size: \"small\",\n    onClick: e => changeOffsetDay(false),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 151,\n      columnNumber: 9\n    }\n  }, \"\\u2190\"), /*#__PURE__*/React.createElement(\"span\", {\n    style: {\n      backgroundColor: \"#ffffff\",\n      padding: 4\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 156,\n      columnNumber: 9\n    }\n  }, Format.formatTimeInDay(DateUtils.getMyCurrentDayStamp(currentDayOffset)), \"(\", getOffsetString(), \")\"), /*#__PURE__*/React.createElement(Button, {\n    type: \"primary\",\n    size: \"small\",\n    onClick: e => changeOffsetDay(true),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 160,\n      columnNumber: 9\n    }\n  }, \"\\u2192\"), /*#__PURE__*/React.createElement(\"span\", {\n    style: {\n      paddingLeft: 10\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 161,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(Button, {\n    type: \"primary\",\n    size: \"small\",\n    onClick: e => download(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 162,\n      columnNumber: 9\n    }\n  }, \"\\u5BFC\\u51FA\"), /*#__PURE__*/React.createElement(\"input\", {\n    type: \"file\",\n    id: \"upload-file\",\n    multiple: true,\n    onChange: event => upload(event),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 163,\n      columnNumber: 9\n    }\n  })), /*#__PURE__*/React.createElement(Input.Group, {\n    compact: true,\n    style: {\n      width: '96%',\n      margin: '2%'\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 167,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Input, {\n    style: {\n      width: '80%'\n    },\n    placeholder: \"\\u8F93\\u5165\\u4EFB\\u52A1\\uFF0C\\u56DE\\u8F66\\u6DFB\\u52A0\",\n    value: title,\n    onChange: event => setTitle(event.target.value),\n    onPressEnter: onAddNote,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 168,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(Input, {\n    style: {\n      width: '20%'\n    },\n    defaultValue: expectTime,\n    placeholder: \"\\u82B1\\u8D39\\u65F6\\u95F4\",\n    prefix: \"\\u9884\\u8BA1\",\n    suffix: \"h\",\n    onChange: event => setExpectTime(Number(event.target.value)),\n    onPressEnter: onAddNote,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 169,\n      columnNumber: 9\n    }\n  })), /*#__PURE__*/React.createElement(\"span\", {\n    style: {\n      backgroundColor: \"#ffffff\",\n      padding: 4,\n      margin: '2%'\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 172,\n      columnNumber: 7\n    }\n  }, getAllTaskStatus()), /*#__PURE__*/React.createElement(NoteList, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 176,\n      columnNumber: 7\n    }\n  }));\n};\n\nconst NoteItem = styled.div`\nbackground-color: ${props => {\n  if (props.choosed) {\n    return '#f5b52b';\n  } else {\n    return '#ffffff';\n  }\n}};\n:hover{\n\tbackground-color:#b4e7fc;\n};\nopacity : ${props => {\n  if (props.isDone) {\n    return 0.15;\n  } else {\n    return 1;\n  }\n}};;\n`;\n\nconst NoteList = () => {\n  const {\n    storeModel\n  } = stores.useStore('mainmodel');\n  const {\n    currentTask,\n    setCurrentTask\n  } = stores.useStore(CurrentTaskKey);\n  const {\n    currentDoingTask,\n    setCurrentDoingTask\n  } = stores.useStore(CurrentDoingTaskKey);\n  const {\n    save\n  } = stores.useStore('mainmodel');\n  const {\n    currentDayOffset,\n    setCurrentDayOffset\n  } = stores.useStore(CurrentDayOffsetKey);\n  useEffect(() => {\n    // console.log(\"NoteList useEffect\")\n    if (currentDoingTask === undefined) {\n      let doingTasks = storeModel.tasks.filter(value => {\n        return value.isDoing();\n      });\n\n      if (doingTasks.length === 0) {\n        return;\n      }\n\n      if (doingTasks.length > 1) {\n        console.error(`有 ${doingTasks.length} 个任务在运行中，自动关闭`);\n\n        for (let i = 1; i < doingTasks.length; i++) {\n          doingTasks[i].stop();\n        }\n      }\n\n      setCurrentDoingTask(doingTasks[0]);\n    }\n  });\n\n  function onChooseNote(event, note) {\n    event.preventDefault();\n    setCurrentTask(note);\n  }\n\n  const onClickMenu = (param, task) => {\n    task.level = Number(param.key);\n    storeModel.orderTasks();\n    save();\n    param.domEvent.preventDefault(); // 怎么阻止对 parent 的点击事件\n    // param.domEvent.stopPropagation()\n  };\n\n  function getMenu(task) {\n    return /*#__PURE__*/React.createElement(Menu, {\n      onClick: param => onClickMenu(param, task),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 251,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"1\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 252,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 1\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"2\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 253,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 2\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"3\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 254,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 3\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"4\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 255,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 4\"), /*#__PURE__*/React.createElement(Menu.Item, {\n      key: \"5\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 256,\n        columnNumber: 9\n      }\n    }, \"\\u4F18\\u5148\\u7EA7 5\"));\n  }\n\n  function deleteTask(event, task) {\n    Modal.confirm({\n      title: '确定要删除吗？',\n      content: `是否删除任务：${task.title}`,\n\n      onOk() {\n        if (storeModel.removeTask(task)) {\n          message.success(\"删除任务成功\");\n          save();\n        } else {\n          message.error(\"删除任务失败\");\n        }\n      }\n\n    });\n  }\n\n  function startTask(event, task) {\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`);\n      return;\n    }\n\n    if (currentDoingTask != undefined && currentDoingTask.id === task.id) {\n      message.error(`任务已经在进行中，上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`);\n      return;\n    }\n\n    if (task.isDoing()) {\n      // todo 自动恢复\n      message.error(`任务异常中断，重新开始。上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`);\n    }\n\n    if (currentDoingTask != undefined) {\n      currentDoingTask.stop();\n    }\n\n    task.start();\n    setCurrentDoingTask(task);\n    save();\n  }\n\n  function doneTask(event, task) {\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`);\n      return;\n    }\n\n    if (!task.isDoing()) {\n      Modal.confirm({\n        title: '当前任务不在进行中，确定要完成吗？',\n        content: `是否完成任务：${task.title}`,\n\n        onOk() {\n          _realDone(task);\n        }\n\n      });\n      return;\n    }\n\n    task.stop();\n    setCurrentDoingTask(undefined);\n\n    _realDone(task);\n  }\n\n  function _realDone(task) {\n    task.done();\n    storeModel.orderTasks();\n    message.success(\"任务已完成\");\n    save();\n  }\n\n  function getDoingStatusTips(task) {\n    if (task.isDoing()) {\n      return \"施工中⛑ \";\n    } else {\n      return \"\";\n    }\n  }\n\n  function getConsumed(task) {\n    let time = Format.formatDuration(task.getAllDuration());\n\n    if (Utils.isStringEmpty(time)) {\n      return \"\";\n    }\n\n    return `进行${time}(${task.doingDurs.length}次) `;\n  }\n\n  function getDeadline(task) {\n    let deadline = task.getActualDeadline();\n\n    if (deadline <= 0) {\n      return \"\";\n    }\n\n    const leftTime = deadline - Utils.getTimestamp();\n\n    if (leftTime <= 1000) {\n      return `已超期😱 `;\n    }\n\n    let time = Format.formatDuration(leftTime);\n    return `剩余${time} `;\n  }\n\n  function getConsumeExpected(task) {\n    if (task.getActualExpectConsume() <= 0) {\n      return \"\";\n    }\n\n    let left = task.getLeftExpectConsumeTime();\n\n    if (left <= 0) {\n      return `超出${Format.formatDuration(-left)}`;\n    } else {\n      return `还需${Format.formatDuration(left)}`;\n    }\n  }\n\n  function getShowTips(task) {\n    let result = \"  \" + getDoingStatusTips(task) + getConsumed(task) + getDeadline(task) + getConsumeExpected(task);\n    return result;\n  }\n\n  function onChooseDeadline(value, task) {\n    // 整了半天，原来直接 valueOf() 就行，百度了半天\n    // if(value instanceof Moment){\n    //   let moment:Moment = value\n    //   console.log('onOk: ', moment.);\n    // }\n    // console.log('onOk: ', value.valueOf());\n    task.deadlines.push(value.valueOf());\n  }\n\n  function getDeadlineTime(task) {\n    const deadline = task.getActualDeadline();\n\n    if (deadline > 0) {\n      return moment(deadline);\n    }\n\n    return undefined;\n  }\n\n  function formartLevel(level) {\n    switch (level) {\n      case 1:\n        return \"\";\n\n      case 1:\n        return \"\";\n\n      case 1:\n        return \"\";\n\n      case 1:\n        return \"\";\n\n      case 1:\n        return \"\";\n\n      default:\n        return \"\";\n    }\n  }\n\n  return /*#__PURE__*/React.createElement(Container2, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 415,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(List, {\n    size: \"small\",\n    style: {\n      backgroundColor: 'white',\n      margin: \"1%\"\n    },\n    bordered: true,\n    dataSource: storeModel.getTasks(DateUtils.getMyCurrentDayDur(currentDayOffset)),\n    renderItem: task => /*#__PURE__*/React.createElement(NoteItem, {\n      choosed: task.isSameTask(currentTask),\n      key: task.id,\n      onClick: e => onChooseNote(e, task),\n      isDone: task.isDone(),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 422,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(ButtonGroup, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 423,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(Button, {\n      type: \"primary\",\n      size: \"small\",\n      onClick: e => deleteTask(e, task),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 426,\n        columnNumber: 15\n      }\n    }, \"Delete\"), /*#__PURE__*/React.createElement(Button, {\n      type: \"primary\",\n      size: \"small\",\n      onClick: e => startTask(e, task),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 427,\n        columnNumber: 15\n      }\n    }, \"Start\"), /*#__PURE__*/React.createElement(Button, {\n      type: \"primary\",\n      size: \"small\",\n      onClick: e => doneTask(e, task),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 429,\n        columnNumber: 15\n      }\n    }, \"Done\"), /*#__PURE__*/React.createElement(Dropdown, {\n      overlay: getMenu(task),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 430,\n        columnNumber: 15\n      }\n    }, /*#__PURE__*/React.createElement(\"a\", {\n      style: {\n        paddingLeft: 5\n      },\n      className: \"ant-dropdown-link\",\n      onClick: e => e.preventDefault(),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 431,\n        columnNumber: 17\n      }\n    }, task.level, \" \", /*#__PURE__*/React.createElement(DownOutlined, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 432,\n        columnNumber: 32\n      }\n    })))), /*#__PURE__*/React.createElement(DatePicker, {\n      showTime: true,\n      defaultValue: getDeadlineTime(task),\n      onOk: value => onChooseDeadline(value, task),\n      size: \"small\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 437,\n        columnNumber: 13\n      }\n    }), getShowTips(task), /*#__PURE__*/React.createElement(NoteItemInput, {\n      key: task.id,\n      task: task,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 439,\n        columnNumber: 13\n      }\n    })),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 416,\n      columnNumber: 7\n    }\n  }));\n};\n\nconst NoteItemInput = props => {\n  const [content, setContent] = useState(props.task.title);\n  const {\n    save\n  } = stores.useStore('mainmodel');\n\n  function saveTaskTitle(event) {\n    props.task.title = content;\n    save();\n  }\n\n  return /*#__PURE__*/React.createElement(Input, {\n    value: content,\n    onChange: e => setContent(e.target.value),\n    onBlur: saveTaskTitle,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 461,\n      columnNumber: 5\n    }\n  });\n};\n\nexport default TaskListContainer;","map":{"version":3,"sources":["/Users/bear/Develop/vscode/self/study/study1/React/DoingList/doinglist2/src/layouts/TaskListContainer.tsx"],"names":["React","useState","useEffect","styled","Input","message","Button","List","Dropdown","Menu","Modal","DatePicker","DownOutlined","stores","StoreModel","Utils","DateUtils","Format","Task","CurrentTaskKey","CurrentDoingTaskKey","CurrentDayOffsetKey","moment","plainToClass","Container","div","Container2","InputGroup","Group","ButtonGroup","TaskListContainer","storeModel","save","setModel","useStore","currentDayOffset","setCurrentDayOffset","title","setTitle","expectTime","setExpectTime","onAddNote","event","preventDefault","isStringEmpty","error","newTask","init","expectConsumes","push","addTask","changeOffsetDay","isAdd","download","downloadFile","formatTimeInMsToFileName","getTimestamp","JSON","stringify","upload","e","file","target","files","console","log","reader","FileReader","onload","uploadContent","result","confirm","content","onOk","parse","onCancel","readAsText","getOffsetString","base","getAllTaskStatus","notDoneTasks","getTasks","getMyCurrentDayDur","filter","task","isDone","length","consumeFormat","consumes","map","left","getLeftExpectConsumeTime","reduce","a","b","formatDuration","backgroundColor","padding","formatTimeInDay","getMyCurrentDayStamp","paddingLeft","width","margin","value","Number","NoteItem","props","choosed","NoteList","currentTask","setCurrentTask","currentDoingTask","setCurrentDoingTask","undefined","doingTasks","tasks","isDoing","i","stop","onChooseNote","note","onClickMenu","param","level","key","orderTasks","domEvent","getMenu","deleteTask","removeTask","success","startTask","formatTimeInMs","doneTime","id","lastStartTime","start","doneTask","_realDone","done","getDoingStatusTips","getConsumed","time","getAllDuration","doingDurs","getDeadline","deadline","getActualDeadline","leftTime","getConsumeExpected","getActualExpectConsume","getShowTips","onChooseDeadline","deadlines","valueOf","getDeadlineTime","formartLevel","isSameTask","NoteItemInput","setContent","saveTaskTitle"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from 'react';\nimport styled from 'styled-components';\nimport { Input, message, Button, List, Dropdown, Menu, Modal, DatePicker } from 'antd';\n// 这样居然真的行\nimport { ClickParam } from 'antd/lib/menu';\n// import { DateType } from 'antd/lib/date-picker';\nimport { DownOutlined } from '@ant-design/icons';\nimport stores from '../stores';\nimport { StoreModel, Duration } from '../model/model'\nimport Utils from '../utils/Utils'\nimport DateUtils from '../utils/DateUtils'\nimport Format from '../utils/Format'\nimport { Task, Note } from '../model/model'\nimport { CurrentTaskKey } from '../stores/CurrentTaskStore';\nimport { CurrentDoingTaskKey } from '../stores/CurrentDoingTaskStore';\nimport { CurrentDayOffsetKey } from '../stores/CurrentDayOffsetStore';\nimport 'antd/dist/antd.css';\nimport moment from 'moment'\nimport { plainToClass } from \"class-transformer\";\n\nconst Container = styled.div`\n  /* background: #d1d3a2; */\n  /* background: #d1dfff; */\n  background: #282c34;\n`\n\nconst Container2 = styled.div`\n  /* background: #d1d3a2; */\n  /* background: #d1dfff; */\n  background: #282c34;\n  overflow:auto;\n  /* height: 800px; */\n  height: 85vh;\n  margin-top:10px;\n`\n\nconst InputGroup = styled(Input.Group)`\nmargin: 1%;\n`\nconst ButtonGroup = styled(Button.Group)`\nmargin: 1%;\n`\n\nconst TaskListContainer: React.FC = () => {\n  const { storeModel, save, setModel } = stores.useStore('mainmodel') as { storeModel: StoreModel, save: () => void, setModel: (storeModel: StoreModel) => void };\n  const { currentDayOffset, setCurrentDayOffset } = stores.useStore(CurrentDayOffsetKey) as { currentDayOffset: number, setCurrentDayOffset: (offset: number) => void }\n  const [title, setTitle] = useState(\"\");\n  const [expectTime, setExpectTime] = useState(2);\n\n  // React.useEffect(() => {\n  //   console.log(\"TaskListContainer useEffect\")\n  // },[])\n\n  function onAddNote(event: any) {\n    event.preventDefault();\n\n    if (Utils.isStringEmpty(title)) {\n      message.error(\"请输入内容\")\n      return\n    }\n\n    const newTask = new Task()\n    newTask.init(title)\n    newTask.expectConsumes.push(expectTime * 3600 * 1000) // 单位小时，转换\n    storeModel.addTask(newTask)\n    save()\n\n    setTitle(\"\")\n  }\n\n  function changeOffsetDay(isAdd: boolean) {\n    if (isAdd) {\n      setCurrentDayOffset(currentDayOffset + 1)\n    } else {\n      setCurrentDayOffset(currentDayOffset - 1)\n    }\n  }\n\n  function download() {\n    Utils.downloadFile(`DoingList_${Format.formatTimeInMsToFileName(Utils.getTimestamp())}.dl`, JSON.stringify(storeModel))\n  }\n\n  function upload(e: any) {\n    let file = e.target.files[0];\n    console.log(file)\n\n    let reader = new FileReader();\n    reader.onload = function (this) {\n      let uploadContent = this.result\n      if (typeof uploadContent === 'string') {\n        Modal.confirm({\n          title: '确定要导入嘛？',\n          content: `导入会覆盖当前所有任务`,\n          onOk() {\n            Modal.confirm({\n              title: '是否需要先下载当前任务？',\n              content: ``,\n              onOk() {\n                download()\n                setModel(plainToClass(StoreModel, JSON.parse(uploadContent as string)))\n              },\n              onCancel() {\n                setModel(plainToClass(StoreModel, JSON.parse(uploadContent as string)))\n              }\n            });\n          },\n        })\n      } else {\n        message.error(\"导入文件有问题，导入失败\")\n      }\n    }\n    //读取文件内容\n    reader.readAsText(file);\n  }\n\n  function getOffsetString() {\n    let base = \"\" + currentDayOffset\n    if (currentDayOffset > 0) {\n      base = \"+\" + base\n    }\n    return base\n  }\n\n  function getAllTaskStatus(): string {\n    let notDoneTasks = storeModel.getTasks(DateUtils.getMyCurrentDayDur(currentDayOffset)).filter((task) => { return !task.isDone() })\n\n    if (notDoneTasks.length === 0) {\n      return \"\"\n    }\n\n    let consumeFormat = \"\"\n    let consumes: number = notDoneTasks.map((task) => {\n      let left = task.getLeftExpectConsumeTime()\n      if (left < 0) return 0\n      return left\n    }).reduce((a, b) => a + b)\n\n    // console.log(\"getAllTaskStatus\" + consumes)\n    if (consumes > 0) {\n      consumeFormat = `，总剩余预估需要花费${Format.formatDuration(consumes)}`\n    }\n\n    return `共${notDoneTasks.length}个任务未完成${consumeFormat}`\n  }\n\n  return (\n    <Container>\n\n      {/* todo 这个组件可以单独抽出去 */}\n      <ButtonGroup>\n        <Button type=\"primary\" size=\"small\" onClick={(e) => changeOffsetDay(false)}>←</Button>\n\n        {/* 这个取当前时间的操作简直无敌... 蠢 */}\n        {/* <DatePicker defaultValue={moment(moment().format(dateFormat), dateFormat)} format={dateFormat} /> */}\n\n        <span style={{ backgroundColor: \"#ffffff\", padding: 4 }} >\n          {Format.formatTimeInDay(DateUtils.getMyCurrentDayStamp(currentDayOffset))}({getOffsetString()})\n        </span>\n\n        <Button type=\"primary\" size=\"small\" onClick={(e) => changeOffsetDay(true)}>→</Button>\n        <span style={{ paddingLeft: 10 }} ></span>\n        <Button type=\"primary\" size=\"small\" onClick={(e) => download()}>导出</Button>\n        <input type=\"file\" id=\"upload-file\" multiple onChange={(event) => upload(event)} />\n        {/* <Button type=\"primary\" size=\"small\" onClick={(e) => download()}>导入</Button> */}\n      </ButtonGroup>\n\n      <Input.Group compact style={{ width: '96%', margin: '2%' }}>\n        <Input style={{ width: '80%' }} placeholder=\"输入任务，回车添加\" value={title} onChange={(event) => setTitle(event.target.value)} onPressEnter={onAddNote} />\n        <Input style={{ width: '20%' }} defaultValue={expectTime} placeholder=\"花费时间\" prefix=\"预计\" suffix=\"h\" onChange={(event) => setExpectTime(Number(event.target.value))} onPressEnter={onAddNote} />\n      </Input.Group>\n\n      <span style={{ backgroundColor: \"#ffffff\", padding: 4, margin: '2%' }} >\n        {getAllTaskStatus()}\n      </span>\n\n      <NoteList />\n    </Container>\n  );\n}\n\n\nconst NoteItem = styled.div`\nbackground-color: ${(props: { choosed: boolean, isDone: boolean }) => {\n    if (props.choosed) {\n      return '#f5b52b'\n    } else {\n      return '#ffffff'\n    }\n  }\n  };\n:hover{\n\tbackground-color:#b4e7fc;\n};\nopacity : ${(props: { choosed: boolean, isDone: boolean }) => {\n    if (props.isDone) {\n      return 0.15\n    } else {\n      return 1\n    }\n  }\n  };;\n`\nconst NoteList: React.FC = () => {\n  const { storeModel } = stores.useStore('mainmodel') as { storeModel: StoreModel };\n  const { currentTask, setCurrentTask } = stores.useStore(CurrentTaskKey) as { currentTask: Task | undefined, setCurrentTask: (note: Task) => void }\n  const { currentDoingTask, setCurrentDoingTask } = stores.useStore(CurrentDoingTaskKey) as { currentDoingTask: Task | undefined, setCurrentDoingTask: (note: Task | undefined) => void }\n  const { save } = stores.useStore('mainmodel') as { save: () => void };\n  const { currentDayOffset, setCurrentDayOffset } = stores.useStore(CurrentDayOffsetKey) as { currentDayOffset: number, setCurrentDayOffset: (offset: number) => void }\n\n  useEffect(() => {\n    // console.log(\"NoteList useEffect\")\n\n    if (currentDoingTask === undefined) {\n      let doingTasks = storeModel.tasks.filter((value) => { return value.isDoing() })\n\n      if(doingTasks.length === 0){\n        return\n      }\n\n      if (doingTasks.length > 1) {\n        console.error(`有 ${doingTasks.length} 个任务在运行中，自动关闭`)\n\n        for (let i = 1; i < doingTasks.length; i++) {\n          doingTasks[i].stop()\n        }\n      }\n\n      setCurrentDoingTask(doingTasks[0])\n    }\n  });\n\n  function onChooseNote(event: any, note: Task) {\n    event.preventDefault()\n    setCurrentTask(note)\n  }\n\n  const onClickMenu = (param: ClickParam, task: Task) => {\n    task.level = Number(param.key)\n\n    storeModel.orderTasks()\n    save()\n\n    param.domEvent.preventDefault()\n\n    // 怎么阻止对 parent 的点击事件\n    // param.domEvent.stopPropagation()\n  };\n\n  function getMenu(task: Task): React.ReactElement {\n    return (\n      <Menu onClick={(param) => onClickMenu(param, task)}>\n        <Menu.Item key=\"1\">优先级 1</Menu.Item>\n        <Menu.Item key=\"2\">优先级 2</Menu.Item>\n        <Menu.Item key=\"3\">优先级 3</Menu.Item>\n        <Menu.Item key=\"4\">优先级 4</Menu.Item>\n        <Menu.Item key=\"5\">优先级 5</Menu.Item>\n      </Menu>\n    )\n  }\n\n  function deleteTask(event: any, task: Task) {\n    Modal.confirm({\n      title: '确定要删除吗？',\n      content: `是否删除任务：${task.title}`,\n      onOk() {\n        if (storeModel.removeTask(task)) {\n          message.success(\"删除任务成功\")\n          save()\n        } else {\n          message.error(\"删除任务失败\")\n        }\n      },\n    });\n  }\n\n  function startTask(event: any, task: Task) {\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`)\n      return\n    }\n\n    if (currentDoingTask != undefined && currentDoingTask.id === task.id) {\n      message.error(`任务已经在进行中，上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`)\n      return\n    }\n\n    if (task.isDoing()) {\n      // todo 自动恢复\n      message.error(`任务异常中断，重新开始。上次开始时间：${Format.formatTimeInMs(task.lastStartTime())}`)\n    }\n\n    if (currentDoingTask != undefined) {\n      currentDoingTask.stop()\n    }\n\n    task.start()\n    setCurrentDoingTask(task)\n    save()\n  }\n\n  function doneTask(event: any, task: Task) {\n    if (task.isDone()) {\n      message.error(`任务已完成，完成时间:${Format.formatTimeInMs(task.doneTime)}`)\n      return\n    }\n\n    if (!task.isDoing()) {\n      Modal.confirm({\n        title: '当前任务不在进行中，确定要完成吗？',\n        content: `是否完成任务：${task.title}`,\n        onOk() {\n          _realDone(task)\n        },\n      });\n      return\n    }\n\n    task.stop()\n    setCurrentDoingTask(undefined)\n    _realDone(task)\n  }\n\n  function _realDone(task: Task) {\n    task.done()\n    storeModel.orderTasks()\n    message.success(\"任务已完成\")\n    save()\n  }\n\n  function getDoingStatusTips(task: Task): string {\n    if (task.isDoing()) {\n      return \"施工中⛑ \"\n    } else {\n      return \"\"\n    }\n  }\n\n  function getConsumed(task: Task): string {\n    let time = Format.formatDuration(task.getAllDuration());\n    if (Utils.isStringEmpty(time)) {\n      return \"\"\n    }\n    return `进行${time}(${task.doingDurs.length}次) `\n  }\n\n  function getDeadline(task: Task): string {\n    let deadline = task.getActualDeadline()\n    if (deadline <= 0) {\n      return \"\"\n    }\n    const leftTime = deadline - Utils.getTimestamp();\n    if (leftTime <= 1000) {\n      return `已超期😱 `\n    }\n    let time = Format.formatDuration(leftTime);\n    return `剩余${time} `\n  }\n\n  function getConsumeExpected(task: Task): string {\n    if (task.getActualExpectConsume() <= 0) {\n      return \"\"\n    }\n\n    let left = task.getLeftExpectConsumeTime()\n    if (left <= 0) {\n      return `超出${Format.formatDuration(-left)}`\n    } else {\n      return `还需${Format.formatDuration(left)}`\n    }\n  }\n\n  function getShowTips(task: Task): string {\n    let result = \"  \" + getDoingStatusTips(task) + getConsumed(task) + getDeadline(task) + getConsumeExpected(task)\n    return result\n  }\n\n  function onChooseDeadline(value: any, task: Task) {\n    // 整了半天，原来直接 valueOf() 就行，百度了半天\n    // if(value instanceof Moment){\n    //   let moment:Moment = value\n    //   console.log('onOk: ', moment.);\n    // }\n    // console.log('onOk: ', value.valueOf());\n\n    task.deadlines.push(value.valueOf())\n  }\n\n  function getDeadlineTime(task: Task): any {\n    const deadline = task.getActualDeadline();\n    if (deadline > 0) {\n      return moment(deadline)\n    }\n\n    return undefined\n  }\n\n  function formartLevel(level: number): string{\n    switch (level) {\n      case 1:\n        return \"\"\n        case 1:\n          return \"\"\n          case 1:\n        return \"\"\n        case 1:\n        return \"\"\n        case 1:\n        return \"\"\n      default:\n        return \"\"\n    }\n  }\n\n  return (\n    <Container2>\n      <List\n        size=\"small\"\n        style={{ backgroundColor: 'white', margin: \"1%\" }}\n        bordered\n        dataSource={storeModel.getTasks(DateUtils.getMyCurrentDayDur(currentDayOffset))}\n        renderItem={task => (\n          <NoteItem choosed={task.isSameTask(currentTask)} key={task.id} onClick={(e) => onChooseNote(e, task)} isDone={task.isDone()}>\n            <ButtonGroup>\n              {/* 点击整行就是查看且开始，view是只查看不开始。暂时用不着吧 */}\n              {/* <Button type=\"primary\" size=\"small\">view</Button> */}\n              <Button type=\"primary\" size=\"small\" onClick={(e) => deleteTask(e, task)}>Delete</Button>\n              <Button type=\"primary\" size=\"small\" onClick={(e) => startTask(e, task)}>Start</Button>\n              {/* <Button type=\"primary\" size=\"small\" onClick={(e) => startTask(e, task)}>Stop</Button> */}\n              <Button type=\"primary\" size=\"small\" onClick={(e) => doneTask(e, task)}>Done</Button>\n              <Dropdown overlay={getMenu(task)}>\n                <a style={{ paddingLeft: 5 }} className=\"ant-dropdown-link\" onClick={e => e.preventDefault()}>\n                  {task.level} <DownOutlined />\n                </a>\n              </Dropdown>\n            </ButtonGroup>\n            {/* {task.id} */}\n            <DatePicker showTime defaultValue={getDeadlineTime(task)} onOk={value => onChooseDeadline(value, task)} size=\"small\" />\n            {getShowTips(task)}\n            <NoteItemInput key={task.id} task={task} />\n          </NoteItem>\n        )}\n      />\n    </Container2>\n  );\n}\n\ninterface NoteItemInputProps {\n  task: Task;\n}\n\nconst NoteItemInput: React.FC<NoteItemInputProps> = (props) => {\n  const [content, setContent] = useState(props.task.title)\n  const { save } = stores.useStore('mainmodel') as { save: () => void };\n\n  function saveTaskTitle(event: any) {\n    props.task.title = content\n    save()\n  }\n\n  return (\n    <Input value={content} onChange={(e) => setContent(e.target.value)} onBlur={saveTaskTitle} />\n  );\n}\n\nexport default TaskListContainer;"]},"metadata":{},"sourceType":"module"}